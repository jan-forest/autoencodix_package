
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../configs/">
      
      
        <link rel="next" href="../disentanglix/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>Data - Autoencodix</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.e53b48f4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#data-module" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Autoencodix" class="md-header__button md-logo" aria-label="Autoencodix" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Autoencodix
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Data
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Autoencodix" class="md-nav__button md-logo" aria-label="Autoencodix" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Autoencodix
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Data
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Data
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data" class="md-nav__link">
    <span class="md-ellipsis">
      data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.BalancedBatchSampler" class="md-nav__link">
    <span class="md-ellipsis">
      BalancedBatchSampler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BalancedBatchSampler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.BalancedBatchSampler.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.BalancedBatchSampler.__iter__" class="md-nav__link">
    <span class="md-ellipsis">
      __iter__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.BalancedBatchSampler.__len__" class="md-nav__link">
    <span class="md-ellipsis">
      __len__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.DataFilter" class="md-nav__link">
    <span class="md-ellipsis">
      DataFilter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataFilter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataFilter.available_methods" class="md-nav__link">
    <span class="md-ellipsis">
      available_methods
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataFilter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataFilter.filter" class="md-nav__link">
    <span class="md-ellipsis">
      filter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataFilter.fit_scaler" class="md-nav__link">
    <span class="md-ellipsis">
      fit_scaler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataFilter.scale" class="md-nav__link">
    <span class="md-ellipsis">
      scale
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage" class="md-nav__link">
    <span class="md-ellipsis">
      DataPackage
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataPackage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.__iter__" class="md-nav__link">
    <span class="md-ellipsis">
      __iter__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.__setitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __setitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.format_shapes" class="md-nav__link">
    <span class="md-ellipsis">
      format_shapes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.get_common_ids" class="md-nav__link">
    <span class="md-ellipsis">
      get_common_ids
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.get_modality_key" class="md-nav__link">
    <span class="md-ellipsis">
      get_modality_key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.get_n_samples" class="md-nav__link">
    <span class="md-ellipsis">
      get_n_samples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.is_empty" class="md-nav__link">
    <span class="md-ellipsis">
      is_empty
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.shape" class="md-nav__link">
    <span class="md-ellipsis">
      shape
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackageSplitter" class="md-nav__link">
    <span class="md-ellipsis">
      DataPackageSplitter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataPackageSplitter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackageSplitter.split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.DataSplitter" class="md-nav__link">
    <span class="md-ellipsis">
      DataSplitter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataSplitter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataSplitter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataSplitter.split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.DatasetContainer" class="md-nav__link">
    <span class="md-ellipsis">
      DatasetContainer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DatasetContainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DatasetContainer.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DatasetContainer.__setitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __setitem__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.GeneralPreprocessor" class="md-nav__link">
    <span class="md-ellipsis">
      GeneralPreprocessor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.ImageDataset" class="md-nav__link">
    <span class="md-ellipsis">
      ImageDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ImageDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.ImageDataset.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.ImageDataset.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.ImageDataset.get_input_dim" class="md-nav__link">
    <span class="md-ellipsis">
      get_input_dim
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.ImagePreprocessor" class="md-nav__link">
    <span class="md-ellipsis">
      ImagePreprocessor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ImagePreprocessor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.ImagePreprocessor.preprocess" class="md-nav__link">
    <span class="md-ellipsis">
      preprocess
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.ImgData" class="md-nav__link">
    <span class="md-ellipsis">
      ImgData
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.MultiModalDataset" class="md-nav__link">
    <span class="md-ellipsis">
      MultiModalDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultiModalDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.MultiModalDataset.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.NaNRemover" class="md-nav__link">
    <span class="md-ellipsis">
      NaNRemover
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NaNRemover">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.NaNRemover.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.NaNRemover.remove_nan" class="md-nav__link">
    <span class="md-ellipsis">
      remove_nan
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.NumericDataset" class="md-nav__link">
    <span class="md-ellipsis">
      NumericDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NumericDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.NumericDataset.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.NumericDataset.__len__" class="md-nav__link">
    <span class="md-ellipsis">
      __len__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.SingleCellFilter" class="md-nav__link">
    <span class="md-ellipsis">
      SingleCellFilter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SingleCellFilter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.SingleCellFilter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.SingleCellFilter.distribute_features_across_modalities" class="md-nav__link">
    <span class="md-ellipsis">
      distribute_features_across_modalities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.SingleCellFilter.general_postsplit_processing" class="md-nav__link">
    <span class="md-ellipsis">
      general_postsplit_processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.SingleCellFilter.presplit_processing" class="md-nav__link">
    <span class="md-ellipsis">
      presplit_processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.SingleCellFilter.sc_postsplit_processing" class="md-nav__link">
    <span class="md-ellipsis">
      sc_postsplit_processing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.StackixDataset" class="md-nav__link">
    <span class="md-ellipsis">
      StackixDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StackixDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.StackixDataset.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.StackixDataset.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.StackixDataset.__len__" class="md-nav__link">
    <span class="md-ellipsis">
      __len__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.StackixDataset.get_modality_item" class="md-nav__link">
    <span class="md-ellipsis">
      get_modality_item
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.StackixPreprocessor" class="md-nav__link">
    <span class="md-ellipsis">
      StackixPreprocessor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StackixPreprocessor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.StackixPreprocessor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.StackixPreprocessor.format_reconstruction" class="md-nav__link">
    <span class="md-ellipsis">
      format_reconstruction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.StackixPreprocessor.preprocess" class="md-nav__link">
    <span class="md-ellipsis">
      preprocess
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.TensorAwareDataset" class="md-nav__link">
    <span class="md-ellipsis">
      TensorAwareDataset
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.XModalPreprocessor" class="md-nav__link">
    <span class="md-ellipsis">
      XModalPreprocessor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="XModalPreprocessor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.XModalPreprocessor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.XModalPreprocessor.preprocess" class="md-nav__link">
    <span class="md-ellipsis">
      preprocess
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../disentanglix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Disentanglix
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Evaluate
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../imagix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Imagix
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../modeling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Modeling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ontix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ontix
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stackix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stackix
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../trainers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trainers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vanillix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vanillix
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../varix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Varix
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../visualize/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Visualize
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data" class="md-nav__link">
    <span class="md-ellipsis">
      data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.BalancedBatchSampler" class="md-nav__link">
    <span class="md-ellipsis">
      BalancedBatchSampler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BalancedBatchSampler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.BalancedBatchSampler.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.BalancedBatchSampler.__iter__" class="md-nav__link">
    <span class="md-ellipsis">
      __iter__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.BalancedBatchSampler.__len__" class="md-nav__link">
    <span class="md-ellipsis">
      __len__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.DataFilter" class="md-nav__link">
    <span class="md-ellipsis">
      DataFilter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataFilter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataFilter.available_methods" class="md-nav__link">
    <span class="md-ellipsis">
      available_methods
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataFilter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataFilter.filter" class="md-nav__link">
    <span class="md-ellipsis">
      filter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataFilter.fit_scaler" class="md-nav__link">
    <span class="md-ellipsis">
      fit_scaler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataFilter.scale" class="md-nav__link">
    <span class="md-ellipsis">
      scale
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage" class="md-nav__link">
    <span class="md-ellipsis">
      DataPackage
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataPackage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.__iter__" class="md-nav__link">
    <span class="md-ellipsis">
      __iter__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.__setitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __setitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.format_shapes" class="md-nav__link">
    <span class="md-ellipsis">
      format_shapes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.get_common_ids" class="md-nav__link">
    <span class="md-ellipsis">
      get_common_ids
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.get_modality_key" class="md-nav__link">
    <span class="md-ellipsis">
      get_modality_key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.get_n_samples" class="md-nav__link">
    <span class="md-ellipsis">
      get_n_samples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.is_empty" class="md-nav__link">
    <span class="md-ellipsis">
      is_empty
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackage.shape" class="md-nav__link">
    <span class="md-ellipsis">
      shape
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackageSplitter" class="md-nav__link">
    <span class="md-ellipsis">
      DataPackageSplitter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataPackageSplitter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataPackageSplitter.split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.DataSplitter" class="md-nav__link">
    <span class="md-ellipsis">
      DataSplitter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataSplitter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataSplitter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DataSplitter.split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.DatasetContainer" class="md-nav__link">
    <span class="md-ellipsis">
      DatasetContainer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DatasetContainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DatasetContainer.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.DatasetContainer.__setitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __setitem__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.GeneralPreprocessor" class="md-nav__link">
    <span class="md-ellipsis">
      GeneralPreprocessor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.ImageDataset" class="md-nav__link">
    <span class="md-ellipsis">
      ImageDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ImageDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.ImageDataset.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.ImageDataset.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.ImageDataset.get_input_dim" class="md-nav__link">
    <span class="md-ellipsis">
      get_input_dim
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.ImagePreprocessor" class="md-nav__link">
    <span class="md-ellipsis">
      ImagePreprocessor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ImagePreprocessor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.ImagePreprocessor.preprocess" class="md-nav__link">
    <span class="md-ellipsis">
      preprocess
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.ImgData" class="md-nav__link">
    <span class="md-ellipsis">
      ImgData
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.MultiModalDataset" class="md-nav__link">
    <span class="md-ellipsis">
      MultiModalDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultiModalDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.MultiModalDataset.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.NaNRemover" class="md-nav__link">
    <span class="md-ellipsis">
      NaNRemover
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NaNRemover">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.NaNRemover.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.NaNRemover.remove_nan" class="md-nav__link">
    <span class="md-ellipsis">
      remove_nan
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.NumericDataset" class="md-nav__link">
    <span class="md-ellipsis">
      NumericDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NumericDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.NumericDataset.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.NumericDataset.__len__" class="md-nav__link">
    <span class="md-ellipsis">
      __len__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.SingleCellFilter" class="md-nav__link">
    <span class="md-ellipsis">
      SingleCellFilter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SingleCellFilter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.SingleCellFilter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.SingleCellFilter.distribute_features_across_modalities" class="md-nav__link">
    <span class="md-ellipsis">
      distribute_features_across_modalities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.SingleCellFilter.general_postsplit_processing" class="md-nav__link">
    <span class="md-ellipsis">
      general_postsplit_processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.SingleCellFilter.presplit_processing" class="md-nav__link">
    <span class="md-ellipsis">
      presplit_processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.SingleCellFilter.sc_postsplit_processing" class="md-nav__link">
    <span class="md-ellipsis">
      sc_postsplit_processing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.StackixDataset" class="md-nav__link">
    <span class="md-ellipsis">
      StackixDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StackixDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.StackixDataset.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.StackixDataset.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.StackixDataset.__len__" class="md-nav__link">
    <span class="md-ellipsis">
      __len__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.StackixDataset.get_modality_item" class="md-nav__link">
    <span class="md-ellipsis">
      get_modality_item
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.StackixPreprocessor" class="md-nav__link">
    <span class="md-ellipsis">
      StackixPreprocessor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StackixPreprocessor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.StackixPreprocessor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.StackixPreprocessor.format_reconstruction" class="md-nav__link">
    <span class="md-ellipsis">
      format_reconstruction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.StackixPreprocessor.preprocess" class="md-nav__link">
    <span class="md-ellipsis">
      preprocess
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.TensorAwareDataset" class="md-nav__link">
    <span class="md-ellipsis">
      TensorAwareDataset
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#autoencodix.data.XModalPreprocessor" class="md-nav__link">
    <span class="md-ellipsis">
      XModalPreprocessor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="XModalPreprocessor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.XModalPreprocessor.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoencodix.data.XModalPreprocessor.preprocess" class="md-nav__link">
    <span class="md-ellipsis">
      preprocess
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="data-module">Data Module</h1>


<div class="doc doc-object doc-module">



<a id="autoencodix.data"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.BalancedBatchSampler" class="doc doc-heading">
            <code>BalancedBatchSampler</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.utils.data.Sampler">Sampler</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code></p>


        <p>A custom PyTorch Sampler that avoids creating a final batch of size 1.</p>
<p>This sampler behaves like a standard <code>BatchSampler</code> but with a key
difference in handling the last batch. If the last batch would normally
have a size of 1, this sampler redistributes the last two batches to be
of roughly equal size. For example, if a dataset of 129 samples is used
with a batch size of 128, instead of yielding batches of [128, 1], it
will yield two balanced batches, such as [65, 64].</p>
<p>This is particularly useful for avoiding issues with layers like
BatchNorm, which require batch sizes greater than 1, without having to
drop data (<code>drop_last=True</code>).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_source</code>
            </td>
            <td>
                  <code><span title="typing.Sized">Sized</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dataset to sample from.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The target number of samples in each batch.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>shuffle</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, the sampler will shuffle the indices at start of each epoch.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_sampler.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BalancedBatchSampler</span><span class="p">(</span><span class="n">Sampler</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom PyTorch Sampler that avoids creating a final batch of size 1.</span>

<span class="sd">    This sampler behaves like a standard `BatchSampler` but with a key</span>
<span class="sd">    difference in handling the last batch. If the last batch would normally</span>
<span class="sd">    have a size of 1, this sampler redistributes the last two batches to be</span>
<span class="sd">    of roughly equal size. For example, if a dataset of 129 samples is used</span>
<span class="sd">    with a batch size of 128, instead of yielding batches of [128, 1], it</span>
<span class="sd">    will yield two balanced batches, such as [65, 64].</span>

<span class="sd">    This is particularly useful for avoiding issues with layers like</span>
<span class="sd">    BatchNorm, which require batch sizes greater than 1, without having to</span>
<span class="sd">    drop data (`drop_last=True`).</span>

<span class="sd">    Args:</span>
<span class="sd">        data_source: The dataset to sample from.</span>
<span class="sd">        batch_size: The target number of samples in each batch.</span>
<span class="sd">        shuffle: If True, the sampler will shuffle the indices at start of each epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_source</span><span class="p">:</span> <span class="n">Sized</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the BalancedBatchSampler.</span>
<span class="sd">        Args:</span>
<span class="sd">            data_source: The dataset to sample from.</span>
<span class="sd">            batch_size: The target number of samples in each batch.</span>
<span class="sd">            shuffle: If True, the sampler will shuffle the indices at start of each epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">batch_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;batch_size should be a positive integer, but got </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">data_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an iterator over batches of indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_samples</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Generate a list of indices</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="c1"># Use a random permutation for shuffling</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>

        <span class="c1"># Check for the special case where the last batch would be of size 1.</span>
        <span class="c1"># This logic only applies if there is more than one batch to begin with.</span>
        <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="ow">and</span> <span class="n">n_samples</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Calculate the number of full batches to yield before special handling</span>
            <span class="n">num_full_batches</span> <span class="o">=</span> <span class="n">n_samples</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="c1"># Yield the full-sized batches</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_full_batches</span><span class="p">):</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
                <span class="k">yield</span> <span class="n">indices</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="c1"># Handle the last two batches by redistributing them</span>
            <span class="n">remaining_indices_start</span> <span class="o">=</span> <span class="n">num_full_batches</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="n">remaining_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">remaining_indices_start</span><span class="p">:]</span>

            <span class="c1"># Split the remaining indices (batch_size + 1) into two roughly equal halves</span>
            <span class="n">split_point</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="k">yield</span> <span class="n">remaining_indices</span><span class="p">[:</span><span class="n">split_point</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">yield</span> <span class="n">remaining_indices</span><span class="p">[</span><span class="n">split_point</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Standard behavior: yield batches of size `batch_size`</span>
            <span class="c1"># The last batch will have size &gt; 1 or there will be no remainder.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the total number of batches in an epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_samples</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># If we are redistributing, we create one extra batch compared to floor division</span>
        <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="ow">and</span> <span class="n">n_samples</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">n_samples</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Standard ceiling division to calculate number of batches</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">n_samples</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.BalancedBatchSampler.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initializes the BalancedBatchSampler.
Args:
    data_source: The dataset to sample from.
    batch_size: The target number of samples in each batch.
    shuffle: If True, the sampler will shuffle the indices at start of each epoch.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_sampler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_source</span><span class="p">:</span> <span class="n">Sized</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the BalancedBatchSampler.</span>
<span class="sd">    Args:</span>
<span class="sd">        data_source: The dataset to sample from.</span>
<span class="sd">        batch_size: The target number of samples in each batch.</span>
<span class="sd">        shuffle: If True, the sampler will shuffle the indices at start of each epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">batch_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;batch_size should be a positive integer, but got </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">data_source</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.BalancedBatchSampler.__iter__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__iter__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns an iterator over batches of indices.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_sampler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an iterator over batches of indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_samples</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Generate a list of indices</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
        <span class="c1"># Use a random permutation for shuffling</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>

    <span class="c1"># Check for the special case where the last batch would be of size 1.</span>
    <span class="c1"># This logic only applies if there is more than one batch to begin with.</span>
    <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="ow">and</span> <span class="n">n_samples</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Calculate the number of full batches to yield before special handling</span>
        <span class="n">num_full_batches</span> <span class="o">=</span> <span class="n">n_samples</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># Yield the full-sized batches</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_full_batches</span><span class="p">):</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="k">yield</span> <span class="n">indices</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Handle the last two batches by redistributing them</span>
        <span class="n">remaining_indices_start</span> <span class="o">=</span> <span class="n">num_full_batches</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="n">remaining_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">remaining_indices_start</span><span class="p">:]</span>

        <span class="c1"># Split the remaining indices (batch_size + 1) into two roughly equal halves</span>
        <span class="n">split_point</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">yield</span> <span class="n">remaining_indices</span><span class="p">[:</span><span class="n">split_point</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">remaining_indices</span><span class="p">[</span><span class="n">split_point</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Standard behavior: yield batches of size `batch_size`</span>
        <span class="c1"># The last batch will have size &gt; 1 or there will be no remainder.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.BalancedBatchSampler.__len__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__len__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns the total number of batches in an epoch.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_sampler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the total number of batches in an epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_samples</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="c1"># If we are redistributing, we create one extra batch compared to floor division</span>
    <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="ow">and</span> <span class="n">n_samples</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n_samples</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Standard ceiling division to calculate number of batches</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">n_samples</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.DataFilter" class="doc doc-heading">
            <code>DataFilter</code>


</h2>


    <div class="doc doc-contents ">


        <p>Preprocesses dataframes, including filtering and scaling.</p>
<p>This class separates the filtering logic that needs to be applied consistently
across train, validation, and test sets from the scaling logic that is
typically fitted on the training data and then applied to the other sets.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.DataFilter.data_info">data_info</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object containing preprocessing parameters.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.DataFilter.filtered_features">filtered_features</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Set">Set</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Set of features to keep after filtering on the training data. None initially.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.DataFilter._scaler">_scaler</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The fitted scaler object. None initially.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.DataFilter.ontologies">ontologies</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ontology information, if provided for Ontix.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.DataFilter.config">config</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object containing default parameters.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_filter.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DataFilter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Preprocesses dataframes, including filtering and scaling.</span>

<span class="sd">    This class separates the filtering logic that needs to be applied consistently</span>
<span class="sd">    across train, validation, and test sets from the scaling logic that is</span>
<span class="sd">    typically fitted on the training data and then applied to the other sets.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        data_info: Configuration object containing preprocessing parameters.</span>
<span class="sd">        filtered_features: Set of features to keep after filtering on the training data. None initially.</span>
<span class="sd">        _scaler: The fitted scaler object. None initially.</span>
<span class="sd">        ontologies: Ontology information, if provided for Ontix.</span>
<span class="sd">        config: Configuration object containing default parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_info</span><span class="p">:</span> <span class="n">DataInfo</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span>
        <span class="n">ontologies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># Addition to Varix, mandotory for Ontix</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the DataFilter with a configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_info: Configuration object containing preprocessing parameters.</span>
<span class="sd">            config: Configuration object containing default parameters.</span>
<span class="sd">            ontologies: Ontology information, if provided for Ontix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span> <span class="o">=</span> <span class="n">data_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtered_features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ontologies</span> <span class="o">=</span> <span class="n">ontologies</span>  <span class="c1"># Addition to Varix, mandotory for Ontix</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_nonzero_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes features with zero variance.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: Input dataframe.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Filtered dataframe containing only columns with non-zero variance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">[</span><span class="n">var</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_by_variance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keeps top k features by variance.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: Input dataframe.</span>
<span class="sd">            k: Number of top variance features to keep. If None or greater</span>
<span class="sd">               than number of columns, all features are kept.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Filtered dataframe with top k variance features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;WARNING: k is None or greater than number of columns, keeping all features.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="n">k</span><span class="p">]]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_by_mad</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keeps top k features by median absolute deviation.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: Input dataframe.</span>
<span class="sd">            k: Number of top MAD features to keep. If None or greater</span>
<span class="sd">               than number of columns, all features are kept.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Filtered dataframe with top k MAD features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="n">mads</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">median_abs_deviation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">mads</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="n">k</span><span class="p">]]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_by_correlation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filters features using correlation-based clustering.</span>

<span class="sd">        This method clusters features based on their correlation distance and</span>
<span class="sd">        selects a representative feature (medoid) from each cluster.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: Input dataframe.</span>
<span class="sd">            k: Number of clusters to create. If None or greater</span>
<span class="sd">               than number of columns, all features are kept.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Filtered dataframe with one representative feature (medoid) per cluster.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;WARNING: k is None or greater than number of columns, keeping all features.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

            <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">squareform</span><span class="p">(</span><span class="n">pdist</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;correlation&quot;</span><span class="p">))</span>

            <span class="n">clustering</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span>
                <span class="n">n_clusters</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">)</span>

            <span class="n">medoid_indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="n">cluster_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span> <span class="o">==</span> <span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># The medoid is the point with minimum sum of distances to other points in the cluster</span>
                    <span class="n">cluster_dist_matrix</span> <span class="o">=</span> <span class="n">dist_matrix</span><span class="p">[</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">cluster_points</span><span class="p">,</span> <span class="n">cluster_points</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="n">sum_distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cluster_dist_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">medoid_idx</span> <span class="o">=</span> <span class="n">cluster_points</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">sum_distances</span><span class="p">)]</span>
                    <span class="n">medoid_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">medoid_idx</span><span class="p">)</span>

            <span class="n">df_filt</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">medoid_indices</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">df_filt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">genes_to_keep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies the configured filtering method to the dataframe.</span>

<span class="sd">        This method is intended to be called on the training data to determine</span>
<span class="sd">        which features to keep. The `filtered_features` attribute will be set</span>
<span class="sd">        based on the result.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: Input dataframe to be filtered (typically the training set).</span>
<span class="sd">            genes_to_keep: A list of gene names to explicitly keep.</span>
<span class="sd">                If provided, other filtering methods will be ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing:</span>
<span class="sd">                - The filtered dataframe.</span>
<span class="sd">                - A list of column names (features) that were kept.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If some genes in `genes_to_keep` are not present in the dataframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">genes_to_keep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">genes_to_keep</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">genes_to_keep</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Some genes in genes_to_keep are not present in the dataframe: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="n">MIN_FILTER</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">filtering_method</span> <span class="o">=</span> <span class="n">FilterMethod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">filtering</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MIN_FILTER</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;WARNING: df is too small for filtering, needs to have at least </span><span class="si">{</span><span class="n">MIN_FILTER</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1">## Remove features which are not in the ontology for Ontix architecture</span>
        <span class="c1">## must be done before other filtering is applied</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;ontologies&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ontologies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_feature_names</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Set</span><span class="p">,</span> <span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ontologies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">all_feature_names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">all_feature_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_feature_names</span><span class="p">)</span>
            <span class="n">feature_order</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">missing_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_order</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_feature_names</span><span class="p">]</span>
            <span class="c1">## Filter out features not in the ontology</span>
            <span class="n">feature_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_order</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_feature_names</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">missing_features</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Features in feature_order not found in all_feature_names: </span><span class="si">{</span><span class="n">missing_features</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">feature_order</span><span class="p">]</span>

        <span class="c1">####</span>

        <span class="k">if</span> <span class="n">filtering_method</span> <span class="o">==</span> <span class="n">FilterMethod</span><span class="o">.</span><span class="n">NOFILT</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filtered_df</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filtered_df</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">filtering_method</span> <span class="o">==</span> <span class="n">FilterMethod</span><span class="o">.</span><span class="n">NONZEROVAR</span><span class="p">:</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_nonzero_variance</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filtering_method</span> <span class="o">==</span> <span class="n">FilterMethod</span><span class="o">.</span><span class="n">VAR</span><span class="p">:</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_nonzero_variance</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_variance</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filtering_method</span> <span class="o">==</span> <span class="n">FilterMethod</span><span class="o">.</span><span class="n">MAD</span><span class="p">:</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_nonzero_variance</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_mad</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filtering_method</span> <span class="o">==</span> <span class="n">FilterMethod</span><span class="o">.</span><span class="n">CORR</span><span class="p">:</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_nonzero_variance</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_correlation</span><span class="p">(</span>
                <span class="n">filtered_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">filtering_method</span> <span class="o">==</span> <span class="n">FilterMethod</span><span class="o">.</span><span class="n">VARCORR</span><span class="p">:</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_nonzero_variance</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_variance</span><span class="p">(</span>
                <span class="n">filtered_df</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span> <span class="o">*</span> <span class="mi">10</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Apply correlation filter on the already variance-filtered data</span>
                <span class="n">num_features_after_var</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">k_corr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span><span class="p">,</span> <span class="n">num_features_after_var</span><span class="p">)</span>
                <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_correlation</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">,</span> <span class="n">k_corr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered_df</span><span class="p">,</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_scaler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the scaler based on the configured scaling method.&quot;&quot;&quot;</span>
        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">scaling</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;NOTSET&quot;</span><span class="p">:</span>
            <span class="c1"># if not set in data config, we use the global scaling config</span>
            <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scaling</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;MINMAX&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;STANDARD&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;ROBUST&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;MAXABS&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="o">=</span> <span class="n">MaxAbsScaler</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_scaler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fits the scaler to the input dataframe (typically the training set).</span>

<span class="sd">        Args:</span>
<span class="sd">            df: Input dataframe to fit the scaler on.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The fitted scaler object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_scaler</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No scaling applied.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">scale</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">scaler</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies the fitted scaler to the input dataframe.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: Input dataframe to be scaled.</span>
<span class="sd">            scaler: The fitted scaler object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Scaled dataframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No scaler has been fitted yet or scaling is set to none.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="n">df_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df_scaled</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">available_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lists all available filtering methods.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of available filtering method names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">method</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">FilterMethod</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="autoencodix.data.DataFilter.available_methods" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">available_methods</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Lists all available filtering methods.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of available filtering method names.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataFilter.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">data_info</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">ontologies</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initializes the DataFilter with a configuration.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_info</code>
            </td>
            <td>
                  <code><span title="autoencodix.configs.default_config.DataInfo">DataInfo</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object containing preprocessing parameters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DefaultConfig (autoencodix.configs.default_config.DefaultConfig)" href="../configs/#autoencodix.configs.DefaultConfig">DefaultConfig</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object containing default parameters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ontologies</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="tuple">tuple</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ontology information, if provided for Ontix.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_filter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">data_info</span><span class="p">:</span> <span class="n">DataInfo</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span>
    <span class="n">ontologies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># Addition to Varix, mandotory for Ontix</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the DataFilter with a configuration.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_info: Configuration object containing preprocessing parameters.</span>
<span class="sd">        config: Configuration object containing default parameters.</span>
<span class="sd">        ontologies: Ontology information, if provided for Ontix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span> <span class="o">=</span> <span class="n">data_info</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filtered_features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ontologies</span> <span class="o">=</span> <span class="n">ontologies</span>  <span class="c1"># Addition to Varix, mandotory for Ontix</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataFilter.filter" class="doc doc-heading">
            <code class="highlight language-python"><span class="nb">filter</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">genes_to_keep</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Applies the configured filtering method to the dataframe.</p>
<p>This method is intended to be called on the training data to determine
which features to keep. The <code>filtered_features</code> attribute will be set
based on the result.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dataframe to be filtered (typically the training set).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>genes_to_keep</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of gene names to explicitly keep.
If provided, other filtering methods will be ignored.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="typing.Union">Union</span>[<span title="pandas.Series">Series</span>, <span title="pandas.DataFrame">DataFrame</span>], <span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing:
- The filtered dataframe.
- A list of column names (features) that were kept.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="KeyError">KeyError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If some genes in <code>genes_to_keep</code> are not present in the dataframe.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_filter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">genes_to_keep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Applies the configured filtering method to the dataframe.</span>

<span class="sd">    This method is intended to be called on the training data to determine</span>
<span class="sd">    which features to keep. The `filtered_features` attribute will be set</span>
<span class="sd">    based on the result.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: Input dataframe to be filtered (typically the training set).</span>
<span class="sd">        genes_to_keep: A list of gene names to explicitly keep.</span>
<span class="sd">            If provided, other filtering methods will be ignored.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing:</span>
<span class="sd">            - The filtered dataframe.</span>
<span class="sd">            - A list of column names (features) that were kept.</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If some genes in `genes_to_keep` are not present in the dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">genes_to_keep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">genes_to_keep</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">genes_to_keep</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Some genes in genes_to_keep are not present in the dataframe: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="n">MIN_FILTER</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">filtering_method</span> <span class="o">=</span> <span class="n">FilterMethod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">filtering</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MIN_FILTER</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;WARNING: df is too small for filtering, needs to have at least </span><span class="si">{</span><span class="n">MIN_FILTER</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1">## Remove features which are not in the ontology for Ontix architecture</span>
    <span class="c1">## must be done before other filtering is applied</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;ontologies&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ontologies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">all_feature_names</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Set</span><span class="p">,</span> <span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ontologies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">all_feature_names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">all_feature_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_feature_names</span><span class="p">)</span>
        <span class="n">feature_order</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">missing_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_order</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_feature_names</span><span class="p">]</span>
        <span class="c1">## Filter out features not in the ontology</span>
        <span class="n">feature_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_order</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_feature_names</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">missing_features</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Features in feature_order not found in all_feature_names: </span><span class="si">{</span><span class="n">missing_features</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">feature_order</span><span class="p">]</span>

    <span class="c1">####</span>

    <span class="k">if</span> <span class="n">filtering_method</span> <span class="o">==</span> <span class="n">FilterMethod</span><span class="o">.</span><span class="n">NOFILT</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">filtered_df</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">filtered_df</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">filtering_method</span> <span class="o">==</span> <span class="n">FilterMethod</span><span class="o">.</span><span class="n">NONZEROVAR</span><span class="p">:</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_nonzero_variance</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">filtering_method</span> <span class="o">==</span> <span class="n">FilterMethod</span><span class="o">.</span><span class="n">VAR</span><span class="p">:</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_nonzero_variance</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_variance</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">filtering_method</span> <span class="o">==</span> <span class="n">FilterMethod</span><span class="o">.</span><span class="n">MAD</span><span class="p">:</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_nonzero_variance</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_mad</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">filtering_method</span> <span class="o">==</span> <span class="n">FilterMethod</span><span class="o">.</span><span class="n">CORR</span><span class="p">:</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_nonzero_variance</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_correlation</span><span class="p">(</span>
            <span class="n">filtered_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">filtering_method</span> <span class="o">==</span> <span class="n">FilterMethod</span><span class="o">.</span><span class="n">VARCORR</span><span class="p">:</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_nonzero_variance</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">)</span>
        <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_variance</span><span class="p">(</span>
            <span class="n">filtered_df</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span> <span class="o">*</span> <span class="mi">10</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Apply correlation filter on the already variance-filtered data</span>
            <span class="n">num_features_after_var</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">k_corr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span><span class="p">,</span> <span class="n">num_features_after_var</span><span class="p">)</span>
            <span class="n">filtered_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_correlation</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">,</span> <span class="n">k_corr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filtered_df</span><span class="p">,</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataFilter.fit_scaler" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_scaler</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Fits the scaler to the input dataframe (typically the training set).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="pandas.Series">Series</span>, <span title="pandas.DataFrame">DataFrame</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dataframe to fit the scaler on.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The fitted scaler object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_filter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fit_scaler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fits the scaler to the input dataframe (typically the training set).</span>

<span class="sd">    Args:</span>
<span class="sd">        df: Input dataframe to fit the scaler on.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The fitted scaler object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_init_scaler</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No scaling applied.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataFilter.scale" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">scaler</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Applies the fitted scaler to the input dataframe.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="pandas.Series">Series</span>, <span title="pandas.DataFrame">DataFrame</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dataframe to be scaled.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scaler</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The fitted scaler object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="pandas.Series">Series</span>, <span title="pandas.DataFrame">DataFrame</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scaled dataframe.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_filter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">scale</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">scaler</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Applies the fitted scaler to the input dataframe.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: Input dataframe to be scaled.</span>
<span class="sd">        scaler: The fitted scaler object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Scaled dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No scaler has been fitted yet or scaling is set to none.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="n">df_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df_scaled</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.DataPackage" class="doc doc-heading">
            <code>DataPackage</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


        <p>Represents a data package containing multiple types of data.</p>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/datapackage.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DataPackage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a data package containing multiple types of data.&quot;&quot;&quot;</span>

    <span class="n">multi_sc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MuData</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># # ty: ignore[invalid-type-form]</span>
    <span class="n">multi_bulk</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">annotation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ImgData</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">from_modality</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">Dict</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Union</span><span class="p">[</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                <span class="n">List</span><span class="p">[</span><span class="n">ImgData</span><span class="p">],</span>
                <span class="n">MuData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
                <span class="n">AnnData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
            <span class="p">],</span>
        <span class="p">]</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">to_modality</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">Dict</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Union</span><span class="p">[</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                <span class="n">List</span><span class="p">[</span><span class="n">ImgData</span><span class="p">],</span>
                <span class="n">MuData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
                <span class="n">AnnData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
            <span class="p">],</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
        <span class="p">]</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Allow dictionary-like access to top-level attributes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not found in DataPackage.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Allow dictionary-like item assignment to top-level attributes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not found in DataPackage.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make DataPackage iterable, yielding (key, value) pairs.</span>

<span class="sd">        For dictionary attributes, yields nested items as (parent_key.child_key, value).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__annotations__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">attr_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">attr_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">sub_key</span><span class="p">,</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">attr_value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">sub_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format the shape dictionary in a clean, readable way.&quot;&quot;&quot;</span>
        <span class="n">shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">data_info</span> <span class="ow">in</span> <span class="n">shapes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Skip empty entries</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data_info</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">sub_items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">subtype</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">data_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="n">sub_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subtype</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> samples  </span><span class="si">{</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> features&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sub_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subtype</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2"> items&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sub_items</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sub_items</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Empty DataPackage&quot;</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_shapes</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the data package is empty.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">multi_sc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">multi_bulk</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_bulk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_modality</span><span class="p">,</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_modality</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_n_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of samples for each data type in nested dictionary format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with nested structure: {modality_type: {sub_key: count}}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_samples</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Process each main attribute</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__annotations__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">attr_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># Handle dictionary attributes (multi_sc, multi_bulk, etc.)</span>
                <span class="n">sub_counts</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">sub_key</span><span class="p">,</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">attr_value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">sub_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">sub_counts</span><span class="p">[</span><span class="n">sub_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_n_samples</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span>
                <span class="n">n_samples</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_counts</span> <span class="k">if</span> <span class="n">sub_counts</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Handle non-dictionary attributes</span>
                <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_n_samples</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span>
                <span class="n">n_samples</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr_name</span><span class="p">:</span> <span class="n">count</span><span class="p">}</span>

        <span class="n">paired_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_paired_count</span><span class="p">()</span>
        <span class="n">n_samples</span><span class="p">[</span><span class="s2">&quot;paired_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;paired_count&quot;</span><span class="p">:</span> <span class="n">paired_count</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">n_samples</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_paired_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the number of samples that are common across modalities that have data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Number of common samples across modalities with data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_counts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Collect all sample counts from modalities that have data</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__annotations__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">attr_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">attr_value</span><span class="p">:</span>  <span class="c1"># Non-empty dictionary</span>
                    <span class="k">for</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">attr_value</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">sub_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_n_samples</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">all_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_n_samples</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">all_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

        <span class="c1"># Return minimum count (intersection) or 0 if no data</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">all_counts</span><span class="p">)</span> <span class="k">if</span> <span class="n">all_counts</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_common_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the common sample IDs across modalities that have data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of sample IDs that are present in all modalities with data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Collect sample IDs from each modality that has data</span>
        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__annotations__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">attr_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">attr_value</span><span class="p">:</span>  <span class="c1"># Non-empty dictionary</span>
                    <span class="k">for</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">attr_value</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">sub_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sample_ids</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">ids</span><span class="p">:</span>
                                <span class="n">all_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sample_ids</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="n">all_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

        <span class="c1"># Find intersection of all ID sets</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">common</span> <span class="o">=</span> <span class="n">all_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">id_set</span> <span class="ow">in</span> <span class="n">all_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">common</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">id_set</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">common</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_sample_ids</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataobj</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">MuData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="n">List</span><span class="p">[</span><span class="n">ImgData</span><span class="p">],</span>
            <span class="n">AnnData</span><span class="p">,</span>
        <span class="p">],</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract sample IDs from a data object.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataobj: Data object to extract IDs from</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of sample IDs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dataobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataobj</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataobj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># For lists of ImgData, extract sample_id from each object</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">img_data</span><span class="o">.</span><span class="n">sample_id</span>
                <span class="k">for</span> <span class="n">img_data</span> <span class="ow">in</span> <span class="n">dataobj</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">img_data</span><span class="p">,</span> <span class="s2">&quot;sample_id&quot;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataobj</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataobj</span><span class="p">,</span> <span class="n">MuData</span><span class="p">):</span>
            <span class="c1"># For MuData, we can use the obs.index directly</span>
            <span class="k">return</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  <span class="c1"># ty: ignore</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_n_samples</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataobj</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">MuData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="n">List</span><span class="p">[</span><span class="n">ImgData</span><span class="p">],</span>
            <span class="n">AnnData</span><span class="p">,</span>
            <span class="n">Dict</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of samples for a specific attribute.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dataobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataobj</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataobj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dataobj</span><span class="p">:</span>  <span class="c1"># Empty dict</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="n">first_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dataobj</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_n_samples</span><span class="p">(</span><span class="n">first_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataobj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataobj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataobj</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataobj</span><span class="p">,</span> <span class="n">MuData</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">mod</span><span class="p">:</span>  <span class="c1"># ty: ignore</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">n_obs</span>  <span class="c1"># ty: ignore</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown data type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataobj</span><span class="p">)</span><span class="si">}</span><span class="s2"> for dataobj. Probably you&#39;ve implemented a new attribute in the DataPackage class or changed the data type of an existing attribute.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the shape of the data for each data type in nested dictionary format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with nested structure: {modality_type: {sub_key: shape}}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shapes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__annotations__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">attr_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># Handle dictionary attributes</span>
                <span class="k">if</span> <span class="n">attr_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Empty or None dictionary</span>
                    <span class="n">shapes</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sub_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_shape_from_dict</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span>
                    <span class="n">shapes</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_dict</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Handle non-dictionary attributes</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_single_shape</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span>
                <span class="n">shapes</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr_name</span><span class="p">:</span> <span class="n">shape</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">shapes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_single_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataobj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get shape for a single data object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dataobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataobj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataobj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataobj</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataobj</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataobj</span><span class="p">,</span> <span class="n">MuData</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">dataobj</span><span class="o">.</span><span class="n">n_obs</span><span class="p">,</span> <span class="n">dataobj</span><span class="o">.</span><span class="n">n_vars</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_shape_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively process dictionary to extract shapes of contained data objects.</span>

<span class="sd">        Args::</span>
<span class="sd">            data_dict: Dictionary containing data objects</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with shapes information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># For lists of objects, just store the length</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">MuData</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">n_obs</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">n_vars</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># Recursively process nested dictionaries</span>
                <span class="n">nested_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_shape_from_dict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nested_result</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For unknown types, store a descriptive string instead of raising an error</span>
                <span class="c1"># This is more robust as it won&#39;t crash the entire method</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_modality_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the first key for a specific direction&#39;s modality.</span>

<span class="sd">        Args:</span>
<span class="sd">            direction: Either &#39;from&#39; or &#39;to&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            First key of the modality dictionary or None if empty</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Direction must be &#39;from&#39; or &#39;to&#39;, got </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">modality_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_modality</span> <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;from&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_modality</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">modality_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">modality_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataPackage.__getitem__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Allow dictionary-like access to top-level attributes.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/datapackage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Allow dictionary-like access to top-level attributes.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not found in DataPackage.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataPackage.__iter__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__iter__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Make DataPackage iterable, yielding (key, value) pairs.</p>
<p>For dictionary attributes, yields nested items as (parent_key.child_key, value).</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/datapackage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make DataPackage iterable, yielding (key, value) pairs.</span>

<span class="sd">    For dictionary attributes, yields nested items as (parent_key.child_key, value).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__annotations__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">attr_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">attr_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sub_key</span><span class="p">,</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">attr_value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">sub_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataPackage.__setitem__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Allow dictionary-like item assignment to top-level attributes.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/datapackage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Allow dictionary-like item assignment to top-level attributes.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not found in DataPackage.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataPackage.format_shapes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">format_shapes</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Format the shape dictionary in a clean, readable way.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/datapackage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">format_shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format the shape dictionary in a clean, readable way.&quot;&quot;&quot;</span>
    <span class="n">shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">data_info</span> <span class="ow">in</span> <span class="n">shapes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Skip empty entries</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_info</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">sub_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">subtype</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">data_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">sub_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subtype</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> samples  </span><span class="si">{</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> features&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sub_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subtype</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2"> items&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sub_items</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sub_items</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Empty DataPackage&quot;</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataPackage.get_common_ids" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_common_ids</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get the common sample IDs across modalities that have data.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of sample IDs that are present in all modalities with data</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/datapackage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_common_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the common sample IDs across modalities that have data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of sample IDs that are present in all modalities with data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_ids</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Collect sample IDs from each modality that has data</span>
    <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__annotations__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">attr_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attr_value</span><span class="p">:</span>  <span class="c1"># Non-empty dictionary</span>
                <span class="k">for</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">attr_value</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">sub_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sample_ids</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ids</span><span class="p">:</span>
                            <span class="n">all_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sample_ids</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ids</span><span class="p">:</span>
                <span class="n">all_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

    <span class="c1"># Find intersection of all ID sets</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_ids</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">common</span> <span class="o">=</span> <span class="n">all_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">id_set</span> <span class="ow">in</span> <span class="n">all_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">common</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">id_set</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">common</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataPackage.get_modality_key" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_modality_key</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get the first key for a specific direction's modality.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>direction</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either 'from' or 'to'</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First key of the modality dictionary or None if empty</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/datapackage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_modality_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the first key for a specific direction&#39;s modality.</span>

<span class="sd">    Args:</span>
<span class="sd">        direction: Either &#39;from&#39; or &#39;to&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        First key of the modality dictionary or None if empty</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Direction must be &#39;from&#39; or &#39;to&#39;, got </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">modality_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_modality</span> <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;from&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_modality</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">modality_dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">modality_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataPackage.get_n_samples" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_n_samples</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get the number of samples for each data type in nested dictionary format.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with nested structure: {modality_type: {sub_key: count}}</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/datapackage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_n_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the number of samples for each data type in nested dictionary format.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with nested structure: {modality_type: {sub_key: count}}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_samples</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Process each main attribute</span>
    <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__annotations__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">attr_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Handle dictionary attributes (multi_sc, multi_bulk, etc.)</span>
            <span class="n">sub_counts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">sub_key</span><span class="p">,</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">attr_value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">sub_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">sub_counts</span><span class="p">[</span><span class="n">sub_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_n_samples</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span>
            <span class="n">n_samples</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_counts</span> <span class="k">if</span> <span class="n">sub_counts</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Handle non-dictionary attributes</span>
            <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_n_samples</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span>
            <span class="n">n_samples</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr_name</span><span class="p">:</span> <span class="n">count</span><span class="p">}</span>

    <span class="n">paired_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_paired_count</span><span class="p">()</span>
    <span class="n">n_samples</span><span class="p">[</span><span class="s2">&quot;paired_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;paired_count&quot;</span><span class="p">:</span> <span class="n">paired_count</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">n_samples</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataPackage.is_empty" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_empty</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Check if the data package is empty.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/datapackage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the data package is empty.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multi_sc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multi_bulk</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_bulk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_modality</span><span class="p">,</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_modality</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataPackage.shape" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">shape</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get the shape of the data for each data type in nested dictionary format.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with nested structure: {modality_type: {sub_key: shape}}</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/datapackage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the shape of the data for each data type in nested dictionary format.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with nested structure: {modality_type: {sub_key: shape}}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shapes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__annotations__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">attr_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Handle dictionary attributes</span>
            <span class="k">if</span> <span class="n">attr_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Empty or None dictionary</span>
                <span class="n">shapes</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sub_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_shape_from_dict</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span>
                <span class="n">shapes</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Handle non-dictionary attributes</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_single_shape</span><span class="p">(</span><span class="n">attr_value</span><span class="p">)</span>
            <span class="n">shapes</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr_name</span><span class="p">:</span> <span class="n">shape</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">shapes</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.DataPackageSplitter" class="doc doc-heading">
            <code>DataPackageSplitter</code>


</h2>


    <div class="doc doc-contents ">


        <p>Splits DataPackage objects into training, validation, and testing sets.</p>
<p>Supports paired and unpaired (translation) splitting.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.DataPackageSplitter.data_package">data_package</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The original DataPackage to split.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.DataPackageSplitter.config">config</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The configuration settings for the splitting process.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.DataPackageSplitter.indices">indices</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The indices for each split (train/val/test).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_datapackage_splitter.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DataPackageSplitter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Splits DataPackage objects into training, validation, and testing sets.</span>

<span class="sd">    Supports paired and unpaired (translation) splitting.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        data_package: The original DataPackage to split.</span>
<span class="sd">        config: The configuration settings for the splitting process.</span>
<span class="sd">        indices: The indices for each split (train/val/test).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_package</span><span class="p">:</span> <span class="n">DataPackage</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span>
        <span class="n">indices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_package</span> <span class="o">=</span> <span class="n">data_package</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_package</span><span class="p">,</span> <span class="n">DataPackage</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expected data_package to be of type DataPackage, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_package</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_shallow_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_indexing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Indexes pd.DataFrame, list, AnnData, or MuData objects using the provided indices.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj: The object to index (can be pd.DataFrame, list, AnnData, MuData, or None).</span>
<span class="sd">            indices: The indices to use for indexing.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The indexed object, or None if the input object is None.</span>
<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If an unsupported type is encountered.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">obj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">AnnData</span><span class="p">,</span> <span class="n">MuData</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;shape of obj: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;obj: </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len(ind): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;max of index</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ind: </span><span class="si">{</span><span class="n">indices</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">obj</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported type for indexing: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Supported types are pd.DataFrame, list, AnnData, and MuData.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_split_data_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataPackage</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a new DataPackage where each attribute is indexed (if applicable)</span>
<span class="sd">        by the given indices. Returns None if indices are empty.</span>

<span class="sd">        Args:</span>
<span class="sd">            indices: The indices to use for splitting the DataPackage.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A new DataPackage with attributes indexed by the provided indices,</span>
<span class="sd">            or None if indices are empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">split_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_package</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">split_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">modality</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexing</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">modality</span><span class="p">][</span><span class="n">split</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">modality</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">DataPackage</span><span class="p">(</span><span class="o">**</span><span class="n">split_data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_split_mudata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mudata</span><span class="p">:</span> <span class="n">MuData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
        <span class="n">indices_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span>
        <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MuData</span><span class="p">:</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Splits a MuData object based on the provided indices map.</span>

<span class="sd">        Args:</span>
<span class="sd">            mudata: The MuData object to split.</span>
<span class="sd">            indices_map: A dictionary mapping modalities to their respective indices.</span>
<span class="sd">            split: The split type (&quot;train&quot;, &quot;valid&quot;, or &quot;test&quot;).</span>
<span class="sd">        Returns:</span>
<span class="sd">            A new MuData object with the specified splits applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">modality</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">indices_map</span><span class="p">[</span><span class="n">modality</span><span class="p">][</span><span class="n">split</span><span class="p">]</span>
            <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">modality</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexing</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mudata</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_requires_paired</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">requires_paired</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">requires_paired</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Splits the underlying DataPackage into train, valid, and test subsets.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A dictionary containing the split data packages for &quot;train&quot;, &quot;valid&quot;, and &quot;test&quot;.</span>
<span class="sd">            Each entry contains a &quot;data&quot; key with the DataPackage and an &quot;indices&quot; key with</span>
<span class="sd">            the corresponding indices.</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If no data package is available for splitting.</span>
<span class="sd">            TypeError: If indices are not provided for unpaired translation case.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_package</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No data package available for splitting&quot;</span><span class="p">)</span>

        <span class="n">splits</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># or split not in self.indices:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">continue</span>
            <span class="n">result</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_data_package</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">),</span>
                <span class="s2">&quot;indices&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataPackageSplitter.split" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">split</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Splits the underlying DataPackage into train, valid, and test subsets.
Returns:
    A dictionary containing the split data packages for "train", "valid", and "test".
    Each entry contains a "data" key with the DataPackage and an "indices" key with
    the corresponding indices.
Raises:
    ValueError: If no data package is available for splitting.
    TypeError: If indices are not provided for unpaired translation case.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_datapackage_splitter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Splits the underlying DataPackage into train, valid, and test subsets.</span>
<span class="sd">    Returns:</span>
<span class="sd">        A dictionary containing the split data packages for &quot;train&quot;, &quot;valid&quot;, and &quot;test&quot;.</span>
<span class="sd">        Each entry contains a &quot;data&quot; key with the DataPackage and an &quot;indices&quot; key with</span>
<span class="sd">        the corresponding indices.</span>
<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If no data package is available for splitting.</span>
<span class="sd">        TypeError: If indices are not provided for unpaired translation case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_package</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No data package available for splitting&quot;</span><span class="p">)</span>

    <span class="n">splits</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span>
    <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># or split not in self.indices:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">continue</span>
        <span class="n">result</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_data_package</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">),</span>
            <span class="s2">&quot;indices&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.DataSplitter" class="doc doc-heading">
            <code>DataSplitter</code>


</h2>


    <div class="doc doc-contents ">


        <p>Splits data into train, validation, and test sets. And validates the splits.</p>
<p>Also allows for custom splits to be provided.
Here we allow empty splits (e.g. test_ratio=0), this might raise an error later
in the pipeline, when this split is expected to be non-empty. However, this allows
are more flexible usage of the pipeline (e.g. when the user only wants to run the fit step).</p>
<p>Constraints:
1. Split ratios must sum to 1
2. Each non-empty split must have at least min_samples_per_split samples
3. Any split ratio must be &lt;= 1.0
4. Custom splits must contain 'train', 'valid', and 'test' keys and non-overlapping indices</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.DataSplitter._config">_config</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object containing split ratios</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.DataSplitter._custom_splits">_custom_splits</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional pre-defined split indices</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_datasplitter.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DataSplitter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Splits data into train, validation, and test sets. And validates the splits.</span>

<span class="sd">    Also allows for custom splits to be provided.</span>
<span class="sd">    Here we allow empty splits (e.g. test_ratio=0), this might raise an error later</span>
<span class="sd">    in the pipeline, when this split is expected to be non-empty. However, this allows</span>
<span class="sd">    are more flexible usage of the pipeline (e.g. when the user only wants to run the fit step).</span>

<span class="sd">    Constraints:</span>
<span class="sd">    1. Split ratios must sum to 1</span>
<span class="sd">    2. Each non-empty split must have at least min_samples_per_split samples</span>
<span class="sd">    3. Any split ratio must be &lt;= 1.0</span>
<span class="sd">    4. Custom splits must contain &#39;train&#39;, &#39;valid&#39;, and &#39;test&#39; keys and non-overlapping indices</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _config: Configuration object containing split ratios</span>

<span class="sd">        _custom_splits: Optional pre-defined split indices</span>
<span class="sd">        _test_ratio</span>
<span class="sd">        _valid_ratio</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span>
        <span class="n">custom_splits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize DataSplitter with configuration and optional custom splits.</span>

<span class="sd">        Args:</span>
<span class="sd">            config (DefaultConfig): Configuration object containing split ratios</span>
<span class="sd">            custom_splits (Optional[Dict[str, np.ndarray]]): Pre-defined split indices</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">test_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">valid_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">train_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">min_samples_per_split</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_custom_splits</span> <span class="o">=</span> <span class="n">custom_splits</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_ratios</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_splits</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_custom_splits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_custom_splits</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_ratios</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that the splitting ratios meet required constraints.</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If ratios violate constraints</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Test ratio must be between 0 and 1, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Validation ratio must be between 0 and 1, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_ratio</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Train ratio must be between 0 and 1, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_train_ratio</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_ratio</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Split ratios must sum to 1&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_split_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that each non-empty split will have sufficient samples.</span>

<span class="sd">        Args:</span>
<span class="sd">            n_samples: Total number of samples in dataset</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If any non-empty split would have too few samples</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Calculate expected sizes</span>
        <span class="n">n_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span><span class="p">))</span>
        <span class="n">n_valid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">n_test</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_ratio</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_train</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_samples</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Training set would have </span><span class="si">{</span><span class="n">n_train</span><span class="si">}</span><span class="s2"> samples, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;which is less than minimum required (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_samples</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_valid</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_samples</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Validation set would have </span><span class="si">{</span><span class="n">n_valid</span><span class="si">}</span><span class="s2"> samples, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;which is less than minimum required (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_samples</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_test</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_samples</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Test set would have </span><span class="si">{</span><span class="n">n_test</span><span class="si">}</span><span class="s2"> samples, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;which is less than minimum required (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_samples</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_custom_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">splits</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate custom splits for correctness.</span>

<span class="sd">        Args:</span>
<span class="sd">            splits: Custom split indices</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If custom splits violate constraints</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">required_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">splits</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Custom splits must contain all of: </span><span class="si">{</span><span class="n">required_keys</span><span class="si">}</span><span class="s2"> \ Got: </span><span class="si">{</span><span class="n">splits</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2"> \ if you want to pass empty splits, pass an empty array&quot;</span>
            <span class="p">)</span>

        <span class="c1"># check for index out of bounds</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_samples</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Custom training split has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> samples, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;which is less than minimum required (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_samples</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># For non-empty validation and test splits, check minimum size</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_samples</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Custom validation split has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> samples, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;which is less than minimum required (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_samples</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_samples</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Custom test split has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> samples, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;which is less than minimum required (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_samples</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Check for overlap between splits</span>
        <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">required_keys</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">intersection</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="n">k1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="n">k2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">intersection</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Overlapping indices found between splits &#39;</span><span class="si">{</span><span class="n">k1</span><span class="si">}</span><span class="s2">&#39; and &#39;</span><span class="si">{</span><span class="n">k2</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">intersection</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split data into train, validation, and test sets.</span>

<span class="sd">        Args:</span>
<span class="sd">            n_samples: Total number of samples in the dataset</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing indices for each split, with empty arrays for splits with ratio=0</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If resulting splits would violate size constraints</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_split_sizes</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_splits</span><span class="p">:</span>
            <span class="n">max_index</span> <span class="o">=</span> <span class="n">n_samples</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_splits</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_index</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Custom split indices must be within range [0, </span><span class="si">{</span><span class="n">max_index</span><span class="si">}</span><span class="s2">]&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Custom split indices must be within range [0, </span><span class="si">{</span><span class="n">max_index</span><span class="si">}</span><span class="s2">]&quot;</span>
                        <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_splits</span>

        <span class="c1"># all three 0 case already handled in _validate_ratios (sum to 1)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span>
                <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_ratio</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_ratio</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span>
                <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">valid_indices</span><span class="p">,</span> <span class="n">test_indices</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                <span class="n">indices</span><span class="p">,</span>
                <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">global_seed</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">valid_indices</span><span class="p">,</span>
                <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">test_indices</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">train_indices</span><span class="p">,</span> <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                <span class="n">indices</span><span class="p">,</span>
                <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">global_seed</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">train_indices</span><span class="p">,</span>
                <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">valid_indices</span><span class="p">,</span>
                <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">train_indices</span><span class="p">,</span> <span class="n">test_indices</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                <span class="n">indices</span><span class="p">,</span>
                <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">global_seed</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">train_indices</span><span class="p">,</span>
                <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">test_indices</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># Normal case: split into all three sets</span>
        <span class="n">train_valid_indices</span><span class="p">,</span> <span class="n">test_indices</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">indices</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">global_seed</span>
        <span class="p">)</span>

        <span class="n">train_indices</span><span class="p">,</span> <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">train_valid_indices</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span><span class="p">),</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">global_seed</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">train_indices</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">valid_indices</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">test_indices</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataSplitter.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">custom_splits</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize DataSplitter with configuration and optional custom splits.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DefaultConfig (autoencodix.configs.default_config.DefaultConfig)" href="../configs/#autoencodix.configs.DefaultConfig">DefaultConfig</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object containing split ratios</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>custom_splits</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pre-defined split indices</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_datasplitter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span>
    <span class="n">custom_splits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize DataSplitter with configuration and optional custom splits.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (DefaultConfig): Configuration object containing split ratios</span>
<span class="sd">        custom_splits (Optional[Dict[str, np.ndarray]]): Pre-defined split indices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">test_ratio</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">valid_ratio</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_train_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">train_ratio</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_min_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">min_samples_per_split</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_custom_splits</span> <span class="o">=</span> <span class="n">custom_splits</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_ratios</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_splits</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_custom_splits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_custom_splits</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DataSplitter.split" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">split</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Split data into train, validation, and test sets.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>n_samples</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total number of samples in the dataset</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing indices for each split, with empty arrays for splits with ratio=0</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If resulting splits would violate size constraints</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_datasplitter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split data into train, validation, and test sets.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_samples: Total number of samples in the dataset</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary containing indices for each split, with empty arrays for splits with ratio=0</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If resulting splits would violate size constraints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_split_sizes</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_splits</span><span class="p">:</span>
        <span class="n">max_index</span> <span class="o">=</span> <span class="n">n_samples</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_splits</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_index</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Custom split indices must be within range [0, </span><span class="si">{</span><span class="n">max_index</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Custom split indices must be within range [0, </span><span class="si">{</span><span class="n">max_index</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_splits</span>

    <span class="c1"># all three 0 case already handled in _validate_ratios (sum to 1)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span>
            <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_ratio</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_ratio</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span>
            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">valid_indices</span><span class="p">,</span> <span class="n">test_indices</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">indices</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">global_seed</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">valid_indices</span><span class="p">,</span>
            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">test_indices</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">train_indices</span><span class="p">,</span> <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">indices</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">global_seed</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">train_indices</span><span class="p">,</span>
            <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">valid_indices</span><span class="p">,</span>
            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">train_indices</span><span class="p">,</span> <span class="n">test_indices</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">indices</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">global_seed</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">train_indices</span><span class="p">,</span>
            <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">test_indices</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># Normal case: split into all three sets</span>
    <span class="n">train_valid_indices</span><span class="p">,</span> <span class="n">test_indices</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
        <span class="n">indices</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">global_seed</span>
    <span class="p">)</span>

    <span class="n">train_indices</span><span class="p">,</span> <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
        <span class="n">train_valid_indices</span><span class="p">,</span>
        <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_valid_ratio</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_ratio</span><span class="p">),</span>
        <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">global_seed</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">train_indices</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="n">valid_indices</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">test_indices</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.DatasetContainer" class="doc doc-heading">
            <code>DatasetContainer</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


        <p>A container for datasets used in training, validation, and testing.</p>
        <p>train : Dataset
    The training dataset.
valid : Dataset
    The validation dataset.
test : Dataset
    The testing dataset.</p>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_datasetcontainer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DatasetContainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A container for datasets used in training, validation, and testing.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    train : Dataset</span>
<span class="sd">        The training dataset.</span>
<span class="sd">    valid : Dataset</span>
<span class="sd">        The validation dataset.</span>
<span class="sd">    test : Dataset</span>
<span class="sd">        The testing dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">train</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">BaseDataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">valid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">BaseDataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">test</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">BaseDataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseDataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Allows dictionary-like access to datasets.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">. Must be &#39;train&#39;, &#39;valid&#39;, or &#39;test&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">BaseDataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Allows dictionary-like assignment of datasets.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">. Must be &#39;train&#39;, &#39;valid&#39;, or &#39;test&#39;.&quot;</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DatasetContainer.__getitem__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Allows dictionary-like access to datasets.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_datasetcontainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseDataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Allows dictionary-like access to datasets.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">}:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">. Must be &#39;train&#39;, &#39;valid&#39;, or &#39;test&#39;.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.DatasetContainer.__setitem__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Allows dictionary-like assignment of datasets.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_datasetcontainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">BaseDataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Allows dictionary-like assignment of datasets.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">}:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">. Must be &#39;train&#39;, &#39;valid&#39;, or &#39;test&#39;.&quot;</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.GeneralPreprocessor" class="doc doc-heading">
            <code>GeneralPreprocessor</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BasePreprocessor (autoencodix.base._base_preprocessor.BasePreprocessor)" href="../base/#autoencodix.base.BasePreprocessor">BasePreprocessor</a></code></p>


        <p>Preprocessor for handling multi-modal data.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.GeneralPreprocessor._datapackage_dict">_datapackage_dict</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary holding DataPackage objects for each data split.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.GeneralPreprocessor._dataset_container">_dataset_container</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="DatasetContainer


  
      dataclass
   (autoencodix.data._datasetcontainer.DatasetContainer)" href="#autoencodix.data.DatasetContainer">DatasetContainer</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Container holding processed datasets for each split.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.GeneralPreprocessor._reverse_mapping_multi_bulk">_reverse_mapping_multi_bulk</span></code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Tuple">Tuple</span>[<span title="typing.List">List</span>[<span title="int">int</span>], <span title="typing.List">List</span>[<span title="str">str</span>]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reverse mapping for multi-bulk data reconstruction.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.GeneralPreprocessor._reverse_mapping_multi_sc">_reverse_mapping_multi_sc</span></code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Tuple">Tuple</span>[<span title="typing.List">List</span>[<span title="int">int</span>], <span title="typing.List">List</span>[<span title="str">str</span>]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reverse mapping for multi-single-cell data reconstruction.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/general_preprocessor.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GeneralPreprocessor</span><span class="p">(</span><span class="n">BasePreprocessor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Preprocessor for handling multi-modal data.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _datapackage_dict: Dictionary holding DataPackage objects for each data split.</span>
<span class="sd">        _dataset_container: Container holding processed datasets for each split.</span>
<span class="sd">        _reverse_mapping_multi_bulk: Reverse mapping for multi-bulk data reconstruction.</span>
<span class="sd">        _reverse_mapping_multi_sc: Reverse mapping for multi-single-cell data reconstruction.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span> <span class="n">ontologies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">ontologies</span><span class="o">=</span><span class="n">ontologies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datapackage_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DatasetContainer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Reverse mappings for reconstruction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_mapping_multi_bulk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_mapping_multi_sc</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_primary_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modality_data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">primary_data</span> <span class="o">=</span> <span class="n">modality_data</span><span class="o">.</span><span class="n">X</span>
        <span class="k">if</span> <span class="n">issparse</span><span class="p">(</span><span class="n">primary_data</span><span class="p">):</span>
            <span class="n">primary_data</span> <span class="o">=</span> <span class="n">primary_data</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">primary_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_layers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">modality_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">modality_data</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="n">layer_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">selected_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_config</span><span class="o">.</span><span class="n">data_info</span><span class="p">[</span>
            <span class="n">modality_name</span>
        <span class="p">]</span><span class="o">.</span><span class="n">selected_layers</span>

        <span class="k">for</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="n">selected_layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer_name</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_primary_data</span><span class="p">(</span><span class="n">modality_data</span><span class="p">)</span>
                <span class="n">layer_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="n">modality_data</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="n">layer_data</span> <span class="o">=</span> <span class="n">modality_data</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">issparse</span><span class="p">(</span><span class="n">layer_data</span><span class="p">):</span>
                    <span class="n">layer_data</span> <span class="o">=</span> <span class="n">layer_data</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
                <span class="n">layer_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">layer_list</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_modality_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mudata</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">MuData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
        <span class="c1"># Reset single-cell reverse mapping</span>
        <span class="n">modality_data_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">modality_name</span><span class="p">,</span> <span class="n">modality_data</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_mapping_multi_sc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">][</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_config</span><span class="o">.</span><span class="n">data_info</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span><span class="o">.</span><span class="n">selected_layers</span>

            <span class="k">for</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">layer_name</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
                    <span class="n">n_feats</span> <span class="o">=</span> <span class="n">modality_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n_feats</span> <span class="o">=</span> <span class="n">modality_data</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">n_feats</span>
                <span class="n">feature_ids</span> <span class="o">=</span> <span class="n">modality_data</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_mapping_multi_sc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">][</span><span class="n">modality_name</span><span class="p">][</span>
                    <span class="n">layer_name</span>
                <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">)),</span>
                    <span class="n">feature_ids</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="n">end_idx</span>

            <span class="n">combined_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_layers</span><span class="p">(</span>
                <span class="n">modality_name</span><span class="o">=</span><span class="n">modality_name</span><span class="p">,</span> <span class="n">modality_data</span><span class="o">=</span><span class="n">modality_data</span>
            <span class="p">)</span>
            <span class="n">modality_data_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">combined_layers</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">modality_data_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_numeric_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span>
        <span class="n">split_ids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">feature_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NumericDataset</span><span class="p">:</span>
        <span class="n">tensor_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">NumericDataset</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">tensor_data</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">split_indices</span><span class="o">=</span><span class="n">split_ids</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">sample_ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="n">feature_ids</span><span class="o">=</span><span class="n">feature_ids</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_data_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">BaseDataset</span><span class="p">:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">split_ids</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]</span>
        <span class="c1"># MULTI-BULK</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_bulk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># reset bulk mapping</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">annotation</span>
            <span class="n">bulk_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_bulk</span>

            <span class="c1"># Check if all DataFrames have the same number of samples</span>
            <span class="n">sample_counts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">subkey</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">bulk_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Expected a DataFrame for &#39;</span><span class="si">{</span><span class="n">subkey</span><span class="si">}</span><span class="s2">&#39;, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="n">sample_counts</span><span class="p">[</span><span class="n">subkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cur shape: </span><span class="si">{</span><span class="n">subkey</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Validate all modalities have the same number of samples</span>
            <span class="n">unique_sample_counts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sample_counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_sample_counts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sample_count_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> samples&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sample_counts</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Different sample counts across modalities are not currently supported for Varix and Vanillix&quot;</span>
                    <span class="s2">&quot;Set requires_pared=True in config.&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Found: </span><span class="si">{</span><span class="n">sample_count_str</span><span class="si">}</span><span class="s2">. All modalities must have the same number of samples.&quot;</span>
                <span class="p">)</span>

            <span class="n">combined_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">subkey</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">bulk_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">n_feats</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">n_feats</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_mapping_multi_bulk</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">][</span><span class="n">subkey</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">)),</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="p">)</span>
                <span class="n">combined_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="n">end_idx</span>

            <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">bulk_dict</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_numeric_dataset</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">combined_df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                <span class="n">split_ids</span><span class="o">=</span><span class="n">split_ids</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">ids</span><span class="o">=</span><span class="n">combined_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="n">feature_ids</span><span class="o">=</span><span class="n">combined_cols</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># MULTI-SINGLE-CELL</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># reset single-cell mapping</span>
            <span class="n">mudata</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">MuData</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
                <span class="s2">&quot;multi_sc&quot;</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
            <span class="k">if</span> <span class="n">mudata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;Unpaired multi Single Cell case not implemented vor Varix and Vanillix, set requires_paired=True in config&quot;</span>
                <span class="p">)</span>
            <span class="n">combined_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_modality_data</span><span class="p">(</span><span class="n">mudata</span><span class="p">)</span>
            <span class="n">combined_obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mod</span><span class="o">.</span><span class="n">obs</span> <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># collect feature IDs in concatenation order</span>
            <span class="n">feature_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">layers</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_mapping_multi_sc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">fids</span> <span class="ow">in</span> <span class="n">layers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">feature_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fids</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_numeric_dataset</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">combined_data</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                <span class="n">split_ids</span><span class="o">=</span><span class="n">split_ids</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">combined_obs</span><span class="p">,</span>
                <span class="n">ids</span><span class="o">=</span><span class="n">combined_obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="n">feature_ids</span><span class="o">=</span><span class="n">feature_ids</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;GeneralPreprocessor only handles multi_bulk or multi_sc.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raw_user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataPackage</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">predict_new_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DatasetContainer</span><span class="p">:</span>
        <span class="c1"># run common preprocessing</span>

        <span class="c1"># self._reverse_mapping_multi_bulk.clear()</span>
        <span class="c1"># self._reverse_mapping_multi_sc.clear()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_datapackage_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_general_preprocess</span><span class="p">(</span>
            <span class="n">raw_user_data</span><span class="o">=</span><span class="n">raw_user_data</span><span class="p">,</span> <span class="n">predict_new_data</span><span class="o">=</span><span class="n">predict_new_data</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datapackage_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Datapackage cannot be None&quot;</span><span class="p">)</span>

        <span class="c1"># prepare container</span>
        <span class="n">ds_container</span><span class="p">:</span> <span class="n">DatasetContainer</span> <span class="o">=</span> <span class="n">DatasetContainer</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">]:</span>
            <span class="n">split_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datapackage_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_split</span> <span class="o">=</span> <span class="n">split</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">split_data</span> <span class="ow">or</span> <span class="n">split_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_container</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
                <span class="k">continue</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_data_package</span><span class="p">(</span><span class="n">split_data</span><span class="p">)</span>
            <span class="n">ds_container</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span> <span class="o">=</span> <span class="n">ds_container</span>
        <span class="k">return</span> <span class="n">ds_container</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_reconstruction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">reconstruction</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Result</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataPackage</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_split</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_split</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="n">reconstruction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_case</span> <span class="o">==</span> <span class="n">DataCase</span><span class="o">.</span><span class="n">MULTI_BULK</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_multi_bulk</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_case</span> <span class="o">==</span> <span class="n">DataCase</span><span class="o">.</span><span class="n">MULTI_SINGLE_CELL</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_multi_sc</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Reconstruction not implemented for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_case</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_match_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Match the split based on the number of samples.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_samples in format recon: </span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">split</span><span class="p">,</span> <span class="n">split_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datapackage_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">split_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">ref_n</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_n_samples</span><span class="p">()[</span><span class="s2">&quot;paired_count&quot;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_samples from datatpackge: </span><span class="si">{</span><span class="n">ref_n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_samples</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">get_n_samples</span><span class="p">()[</span><span class="s2">&quot;paired_count&quot;</span><span class="p">][</span><span class="s2">&quot;paired_count&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">split</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Cannot find matching split for </span><span class="si">{</span><span class="n">n_samples</span><span class="si">}</span><span class="s2"> samples in the dataset.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reverse_multi_bulk</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">reconstruction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataPackage</span><span class="p">:</span>
        <span class="n">data_package</span> <span class="o">=</span> <span class="n">DataPackage</span><span class="p">(</span>
            <span class="n">multi_bulk</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">multi_sc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">img</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">from_modality</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">to_modality</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># reconstruct each bulk subkey</span>
        <span class="n">dfs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">subkey</span><span class="p">,</span> <span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">fids</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_mapping_multi_bulk</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_split</span>
        <span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slice_tensor</span><span class="p">(</span>
                <span class="n">reconstruction</span><span class="o">=</span><span class="n">reconstruction</span><span class="p">,</span>
                <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">dfs</span><span class="p">[</span><span class="n">subkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">arr</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="n">fids</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">]</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">data_package</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span>

        <span class="n">data_package</span><span class="o">.</span><span class="n">multi_bulk</span> <span class="o">=</span> <span class="n">dfs</span>
        <span class="k">return</span> <span class="n">data_package</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_slice_tensor</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">reconstruction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">reconstruction</span><span class="p">[:,</span> <span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">reconstruction</span><span class="p">[:,</span> <span class="n">indices</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expected reconstruction to be a torch.Tensor or np.ndarray, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">arr</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reverse_multi_sc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reconstruction</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataPackage</span><span class="p">:</span>
        <span class="n">data_package</span> <span class="o">=</span> <span class="n">DataPackage</span><span class="p">(</span>
            <span class="n">multi_bulk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">multi_sc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">annotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">img</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">from_modality</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">to_modality</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">modalities</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AnnData</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">modality_name</span><span class="p">,</span> <span class="n">layers</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_mapping_multi_sc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_split</span>
        <span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># rebuild each layer as DataFrame</span>
            <span class="n">layers_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">layer_name</span><span class="p">,</span> <span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">fids</span><span class="p">)</span> <span class="ow">in</span> <span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slice_tensor</span><span class="p">(</span><span class="n">reconstruction</span><span class="o">=</span><span class="n">reconstruction</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
                <span class="n">layers_dict</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">arr</span><span class="p">,</span>
                    <span class="n">columns</span><span class="o">=</span><span class="n">fids</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">]</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># extract X layer for AnnData var</span>
            <span class="n">feature_ids</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[]))[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">feature_ids</span><span class="p">)</span>
            <span class="n">X_df</span> <span class="o">=</span> <span class="n">layers_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">adata</span> <span class="o">=</span> <span class="n">AnnData</span><span class="p">(</span>
                <span class="n">X</span><span class="o">=</span><span class="n">X_df</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">X_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">obs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">var</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                <span class="n">layers</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">layers_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
            <span class="p">)</span>
            <span class="n">modalities</span><span class="p">[</span><span class="n">modality_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span>

        <span class="n">data_package</span><span class="o">.</span><span class="n">multi_sc</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;multi_sc&quot;</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">MuData</span><span class="p">(</span><span class="n">modalities</span><span class="p">)}</span>
        <span class="n">data_package</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">return</span> <span class="n">data_package</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.ImageDataset" class="doc doc-heading">
            <code>ImageDataset</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="TensorAwareDataset (autoencodix.data._numeric_dataset.TensorAwareDataset)" href="#autoencodix.data.TensorAwareDataset">TensorAwareDataset</a></code></p>


        <p>A custom PyTorch dataset that handles image data with proper dtype conversion.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.ImageDataset.raw_data">raw_data</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of ImgData objects containing original image data and metadata.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.ImageDataset.config">config</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object for dataset settings.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.ImageDataset.mytype">mytype</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Enum indicating the dataset type (set to DataSetTypes.IMG).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.ImageDataset.data">data</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of image tensors converted to the appropriate dtype.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.ImageDataset.sample_ids">sample_ids</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of identifiers for each sample.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.ImageDataset.split_indices">split_indices</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional numpy array of indices for splitting the dataset.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.ImageDataset.feature_ids">feature_ids</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of identifiers for each feature (set to None for images).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.ImageDataset.metadata">metadata</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional pandas DataFrame containing additional metadata.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_image_dataset.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ImageDataset</span><span class="p">(</span><span class="n">TensorAwareDataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom PyTorch dataset that handles image data with proper dtype conversion.</span>


<span class="sd">    Attributes:</span>
<span class="sd">        raw_data: List of ImgData objects containing original image data and metadata.</span>
<span class="sd">        config: Configuration object for dataset settings.</span>
<span class="sd">        mytype: Enum indicating the dataset type (set to DataSetTypes.IMG).</span>
<span class="sd">        data: List of image tensors converted to the appropriate dtype.</span>
<span class="sd">        sample_ids: List of identifiers for each sample.</span>
<span class="sd">        split_indices: Optional numpy array of indices for splitting the dataset.</span>
<span class="sd">        feature_ids: Optional list of identifiers for each feature (set to None for images).</span>
<span class="sd">        metadata: Optional pandas DataFrame containing additional metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ImgData</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span>
        <span class="n">split_indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the dataset</span>
<span class="sd">        Args:</span>
<span class="sd">            data: List of image data objects</span>
<span class="sd">            config: Configuration object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">data</span>  <span class="c1"># image data before conversion to keep original infos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mytype</span> <span class="o">=</span> <span class="n">DataSetTypes</span><span class="o">.</span><span class="n">IMG</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;config cannot be None&quot;</span><span class="p">)</span>

        <span class="c1"># Convert all images to tensors with proper dtype once during initialization</span>
        <span class="n">target_dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_target_dtype</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_all_images_to_tensors</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">)</span>

        <span class="c1"># Extract sample_ids for consistency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">img_data</span><span class="o">.</span><span class="n">sample_id</span> <span class="k">for</span> <span class="n">img_data</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">split_indices</span> <span class="o">=</span> <span class="n">split_indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_ids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_all_images_to_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert all images to tensors with specified dtype during initialization.</span>

<span class="sd">        Args:</span>
<span class="sd">            dtype: Target dtype for the tensors</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of converted image tensors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> images to </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> tensors...&quot;</span><span class="p">)</span>
        <span class="n">converted_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">img_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">:</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_tensor</span><span class="p">(</span><span class="n">img_data</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="n">converted_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">converted_data</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get item at index - data is already converted to proper dtype</span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (index, image tensor, sample_id)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the input dimension of the dataset&#39;s feature space.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The input dimension of the dataset&#39;s feature space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># All images should have the same shape</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.ImageDataset.__getitem__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get item at index - data is already converted to proper dtype
Returns:
    Tuple of (index, image tensor, sample_id)</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_image_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get item at index - data is already converted to proper dtype</span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (index, image tensor, sample_id)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.ImageDataset.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">split_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the dataset
Args:
    data: List of image data objects
    config: Configuration object</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_image_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ImgData</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span>
    <span class="n">split_indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the dataset</span>
<span class="sd">    Args:</span>
<span class="sd">        data: List of image data objects</span>
<span class="sd">        config: Configuration object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">data</span>  <span class="c1"># image data before conversion to keep original infos</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mytype</span> <span class="o">=</span> <span class="n">DataSetTypes</span><span class="o">.</span><span class="n">IMG</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;config cannot be None&quot;</span><span class="p">)</span>

    <span class="c1"># Convert all images to tensors with proper dtype once during initialization</span>
    <span class="n">target_dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_target_dtype</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_all_images_to_tensors</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">)</span>

    <span class="c1"># Extract sample_ids for consistency</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">img_data</span><span class="o">.</span><span class="n">sample_id</span> <span class="k">for</span> <span class="n">img_data</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">split_indices</span> <span class="o">=</span> <span class="n">split_indices</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">feature_ids</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.ImageDataset.get_input_dim" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_input_dim</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Gets the input dimension of the dataset's feature space.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="int">int</span>, ...]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input dimension of the dataset's feature space</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_image_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_input_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the input dimension of the dataset&#39;s feature space.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The input dimension of the dataset&#39;s feature space</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># All images should have the same shape</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.ImagePreprocessor" class="doc doc-heading">
            <code>ImagePreprocessor</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="GeneralPreprocessor (autoencodix.data.general_preprocessor.GeneralPreprocessor)" href="#autoencodix.data.GeneralPreprocessor">GeneralPreprocessor</a></code></p>


        <p>Preprocessor for cross-modal data, handling multiple data types and their transformations.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.ImagePreprocessor.data_config">data_config</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration specific to data handling and preprocessing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.ImagePreprocessor.dataset_dicts">dataset_dicts</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary holding datasets for different splits (train/test/valid).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_image_processor.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ImagePreprocessor</span><span class="p">(</span><span class="n">GeneralPreprocessor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Preprocessor for cross-modal data, handling multiple data types and their transformations.</span>


<span class="sd">    Attributes:</span>
<span class="sd">        data_config: Configuration specific to data handling and preprocessing.</span>
<span class="sd">        dataset_dicts: Dictionary holding datasets for different splits (train/test/valid).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span> <span class="n">ontologies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">ontologies</span><span class="o">=</span><span class="n">ontologies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">data_config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raw_user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataPackage</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">predict_new_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DatasetContainer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocess the data according to the configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            raw_user_data: The raw data package provided by the user.</span>
<span class="sd">            predict_new_data: Flag indicating if new data is being predicted.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A DatasetContainer with processed training, validation, and test datasets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_general_preprocess</span><span class="p">(</span>
            <span class="n">raw_user_data</span><span class="o">=</span><span class="n">raw_user_data</span><span class="p">,</span> <span class="n">predict_new_data</span><span class="o">=</span><span class="n">predict_new_data</span>
        <span class="p">)</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">]:</span>
            <span class="n">cur_split</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dicts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cur_split</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;split is None: </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">cur_data</span> <span class="o">=</span> <span class="n">cur_split</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur_data</span><span class="p">,</span> <span class="n">DataPackage</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;expected type of cur_data to be DataPackage, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cur_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">cur_indices</span> <span class="o">=</span> <span class="n">cur_split</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;indices&quot;</span><span class="p">)</span>
            <span class="n">datasets</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_dp</span><span class="p">(</span><span class="n">dp</span><span class="o">=</span><span class="n">cur_data</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">cur_indices</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">DatasetContainer</span><span class="p">(</span>
            <span class="n">train</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span> <span class="n">test</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">],</span> <span class="n">valid</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_dp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dp</span><span class="p">:</span> <span class="n">DataPackage</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ImageDataset</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dp</span><span class="o">.</span><span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no img attribute found in datapackage&quot;</span><span class="p">)</span>
        <span class="n">first_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expected `img` attribute of DataPackage to be `dict`, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">img</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;got multiple image datasets for Imagix: </span><span class="si">{</span><span class="n">dp</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">,</span><span class="se">\</span>
<span class="s2">                          we only support a single image dataset in this case, using: </span><span class="si">{</span><span class="n">first_key</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">dp</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">first_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;paired&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="n">first_key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ImageDataset</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="n">split_indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.ImagePreprocessor.preprocess" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">preprocess</span><span class="p">(</span><span class="n">raw_user_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">predict_new_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Preprocess the data according to the configuration.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>raw_user_data</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="DataPackage


  
      dataclass
   (autoencodix.data.datapackage.DataPackage)" href="#autoencodix.data.DataPackage">DataPackage</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The raw data package provided by the user.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>predict_new_data</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Flag indicating if new data is being predicted.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    A DatasetContainer with processed training, validation, and test datasets.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_image_processor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">raw_user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataPackage</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">predict_new_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DatasetContainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Preprocess the data according to the configuration.</span>

<span class="sd">    Args:</span>
<span class="sd">        raw_user_data: The raw data package provided by the user.</span>
<span class="sd">        predict_new_data: Flag indicating if new data is being predicted.</span>
<span class="sd">    Returns:</span>
<span class="sd">        A DatasetContainer with processed training, validation, and test datasets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_general_preprocess</span><span class="p">(</span>
        <span class="n">raw_user_data</span><span class="o">=</span><span class="n">raw_user_data</span><span class="p">,</span> <span class="n">predict_new_data</span><span class="o">=</span><span class="n">predict_new_data</span>
    <span class="p">)</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">]:</span>
        <span class="n">cur_split</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dicts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cur_split</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;split is None: </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">cur_data</span> <span class="o">=</span> <span class="n">cur_split</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur_data</span><span class="p">,</span> <span class="n">DataPackage</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;expected type of cur_data to be DataPackage, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cur_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">cur_indices</span> <span class="o">=</span> <span class="n">cur_split</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;indices&quot;</span><span class="p">)</span>
        <span class="n">datasets</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_dp</span><span class="p">(</span><span class="n">dp</span><span class="o">=</span><span class="n">cur_data</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">cur_indices</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">DatasetContainer</span><span class="p">(</span>
        <span class="n">train</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span> <span class="n">test</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">],</span> <span class="n">valid</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.ImgData" class="doc doc-heading">
            <code>ImgData</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


        <p>Stores image data along with its associated metadata.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.ImgData.img">img</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The image data as a NumPy array.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.ImgData.sample_id">sample_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A unique identifier for the image sample.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.ImgData.annotation">annotation</span></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="pandas.Series">Series</span>, <span title="pandas.DataFrame">DataFrame</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame containing annotations or metadata related to the image.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_imgdataclass.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ImgData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores image data along with its associated metadata.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        img : The image data as a NumPy array.</span>
<span class="sd">        sample_id: A unique identifier for the image sample.</span>
<span class="sd">        annotation: A DataFrame containing annotations or metadata related to the image.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">sample_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">annotation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ImgData(</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    sample_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_id</span><span class="si">!r}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    img_shape=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;    annotation_shape=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; .  img: actual image data is not shown for brevity, use img attribute to access it&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.MultiModalDataset" class="doc doc-heading">
            <code>MultiModalDataset</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseDataset (autoencodix.base._base_dataset.BaseDataset)" href="../base/#autoencodix.base.BaseDataset">BaseDataset</a></code>, <code><span title="torch.utils.data.Dataset">Dataset</span></code></p>


        <p>Handles multiple datasets of different modalities.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.MultiModalDataset.datasets">datasets</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of datasets for each modality.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.MultiModalDataset.n_modalities">n_modalities</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of modalities.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.MultiModalDataset.sample_to_modalities">sample_to_modalities</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Mapping from sample IDs to available modalities.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.MultiModalDataset.sample_ids">sample_ids</span></code></td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of all unique sample IDs across modalities.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.MultiModalDataset.config">config</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.MultiModalDataset.data">data</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data from the first modality (for compatibility).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.MultiModalDataset.feature_ids">feature_ids</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Feature IDs (currently None, to be implemented).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.MultiModalDataset._id_to_idx">_id_to_idx</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reverse lookup tables for sample IDs to indices per modality.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.MultiModalDataset.paired_sample_ids">paired_sample_ids</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of sample IDs that have data in all modalities.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.MultiModalDataset.unpaired_sample_ids">unpaired_sample_ids</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of sample IDs that do not have data in all modalities.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_multimodal_dataset.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MultiModalDataset</span><span class="p">(</span><span class="n">BaseDataset</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles multiple datasets of different modalities.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        datasets: Dictionary of datasets for each modality.</span>
<span class="sd">        n_modalities: Number of modalities.</span>
<span class="sd">        sample_to_modalities: Mapping from sample IDs to available modalities.</span>
<span class="sd">        sample_ids: List of all unique sample IDs across modalities.</span>
<span class="sd">        config: Configuration object.</span>
<span class="sd">        data: Data from the first modality (for compatibility).</span>
<span class="sd">        feature_ids: Feature IDs (currently None, to be implemented).</span>
<span class="sd">        _id_to_idx: Reverse lookup tables for sample IDs to indices per modality.</span>
<span class="sd">        paired_sample_ids: List of sample IDs that have data in all modalities.</span>
<span class="sd">        unpaired_sample_ids: List of sample IDs that do not have data in all modalities.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datasets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseDataset</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the MultiModalDataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            datasets: Dictionary of datasets for each modality.</span>
<span class="sd">            config: Configuration object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_modalities</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_to_modalities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_sample_map</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_to_modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_ids</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO</span>

        <span class="c1"># Build reverse lookup tables once</span>
        <span class="k">for</span> <span class="n">ds_name</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">sample_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are no sample_ids for </span><span class="si">{</span><span class="n">ds_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id_to_idx</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">mod</span><span class="p">:</span> <span class="p">{</span><span class="n">sid</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">)}</span>  <span class="c1"># type: ignore</span>
            <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paired_sample_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_paired_sample_ids</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpaired_sample_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paired_sample_ids</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_to_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modality</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert the dataset to a pandas DataFrame.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame representation of the dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">modality</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_modality</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_modality</span> <span class="o">=</span> <span class="p">[</span><span class="n">modality</span><span class="p">]</span>

        <span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">modality</span> <span class="ow">in</span> <span class="n">all_modality</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">modality</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown modality: </span><span class="si">{</span><span class="n">modality</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">modality</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">feature_ids</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">sample_ids</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;IMG&quot;</span> <span class="ow">in</span> <span class="n">modality</span><span class="p">:</span>
                <span class="c1"># Handle image modality</span>
                <span class="c1"># Get the list of tensors</span>
                <span class="n">tensor_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">modality</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

                <span class="c1"># Flatten each tensor and collect as rows</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="n">t</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">t</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensor_list</span>
                <span class="p">]</span>

                <span class="c1"># Create DataFrame</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">rows</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Pixel_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]))],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;Data is not a torch.Tensor and cannot be converted to DataFrame.&quot;</span>
                <span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">modality</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">df_all</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">df_all</span> <span class="o">=</span> <span class="n">df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_all</span><span class="p">,</span> <span class="n">df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_all</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_sample_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sample_to_mods</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">modality</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">:</span>
                <span class="n">sample_to_mods</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">modality</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sample_to_mods</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_paired_sample_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">sid</span>
            <span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">mods</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_to_modalities</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">mod</span> <span class="ow">in</span> <span class="n">mods</span> <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paired_sample_ids</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sample_id&quot;</span><span class="p">:</span> <span class="n">sample_id</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sample_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_to_idx</span><span class="p">[</span><span class="n">mod</span><span class="p">]:</span>
                <span class="n">sample</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">continue</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_to_idx</span><span class="p">[</span><span class="n">mod</span><span class="p">][</span><span class="n">sample_id</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">sample</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="n">sample</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.MultiModalDataset.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the MultiModalDataset.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>datasets</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="BaseDataset (autoencodix.base._base_dataset.BaseDataset)" href="../base/#autoencodix.base.BaseDataset">BaseDataset</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of datasets for each modality.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DefaultConfig (autoencodix.configs.default_config.DefaultConfig)" href="../configs/#autoencodix.configs.DefaultConfig">DefaultConfig</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_multimodal_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datasets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseDataset</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the MultiModalDataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        datasets: Dictionary of datasets for each modality.</span>
<span class="sd">        config: Configuration object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_modalities</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sample_to_modalities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_sample_map</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_to_modalities</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">feature_ids</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO</span>

    <span class="c1"># Build reverse lookup tables once</span>
    <span class="k">for</span> <span class="n">ds_name</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">sample_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are no sample_ids for </span><span class="si">{</span><span class="n">ds_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_id_to_idx</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">mod</span><span class="p">:</span> <span class="p">{</span><span class="n">sid</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">)}</span>  <span class="c1"># type: ignore</span>
        <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">paired_sample_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_paired_sample_ids</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">unpaired_sample_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paired_sample_ids</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.NaNRemover" class="doc doc-heading">
            <code>NaNRemover</code>


</h2>


    <div class="doc doc-contents ">


        <p>Removes NaN values from multi-modal datasets.</p>
<p>This object identifies and removes NaN values from various data structures
commonly used in single-cell and multi-modal omics, including AnnData, MuData,
and Pandas DataFrames. It supports processing of X matrices, layers, and
observation annotations within AnnData objects, as well as handling bulk and
annotation data within a DataPackage.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.NaNRemover.config">config</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object containing settings for data processing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.NaNRemover.relevant_cols">relevant_cols</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of columns in metadata to check for NaNs.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_nanremover.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NaNRemover</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removes NaN values from multi-modal datasets.</span>

<span class="sd">    This object identifies and removes NaN values from various data structures</span>
<span class="sd">    commonly used in single-cell and multi-modal omics, including AnnData, MuData,</span>
<span class="sd">    and Pandas DataFrames. It supports processing of X matrices, layers, and</span>
<span class="sd">    observation annotations within AnnData objects, as well as handling bulk and</span>
<span class="sd">    annotation data within a DataPackage.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        config: Configuration object containing settings for data processing.</span>
<span class="sd">        relevant_cols: List of columns in metadata to check for NaNs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the NaNRemover with configuration settings.</span>
<span class="sd">        Args:</span>
<span class="sd">            config: Configuration object containing settings for data processing.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relevant_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_config</span><span class="o">.</span><span class="n">annotation_columns</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_sparse_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts sparse matrix to dense NumPy array and ensures float type.</span>

<span class="sd">        Args:</span>
<span class="sd">            matrix: The input matrix, which can be a sparse matrix (e.g., from scipy.sparse)</span>
<span class="sd">                or a dense NumPy array.</span>

<span class="sd">        Returns</span>
<span class="sd">            A dense NumPy array of float type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">issparse</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">matrix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_nan_from_matrix</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes NaNs from matrix, returns boolean masks for valid rows and columns.</span>

<span class="sd">        Args:</span>
<span class="sd">            matrix: The input matrix (NumPy array or sparse matrix) to process.</span>
<span class="sd">            name: An optional string identifier for the matrix, used for printing</span>
<span class="sd">                (though not currently implemented in the provided code).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing two boolean NumPy arrays:</span>
<span class="sd">            - valid_rows: A 1D boolean array where True indicates a row without NaNs.</span>
<span class="sd">            - valid_cols: A 1D boolean array where True indicates a column without NaNs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_sparse_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">valid_cols</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">valid_rows</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;matrix&quot;</span>

        <span class="k">return</span> <span class="n">valid_rows</span><span class="p">,</span> <span class="n">valid_cols</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_modality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adata</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts NaN values in AnnData object to zero and metadata NaNs to &#39;missing&#39;.</span>
<span class="sd">        Args:</span>
<span class="sd">            adata: The AnnData object to process.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The processed AnnData object with NaN values replaced.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Handle X matrix</span>
        <span class="k">if</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">):</span>
                <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span>  <span class="c1"># ty:  ignore</span>
                    <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="p">)</span>  <span class="c1"># ty: ignore[invalid-assignment]</span>
                <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">eliminate_zeros</span><span class="p">()</span>  <span class="c1"># ty: ignore</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># Handle all layers</span>
        <span class="k">for</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">layer_data</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">layer_data</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer_data</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">):</span>
                    <span class="n">layer_data</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">layer_data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">layer_data</span><span class="o">.</span><span class="n">eliminate_zeros</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">layer_data</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># Handle obs metadata</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_cols</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;missing&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">adata</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_nan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataPackage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataPackage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes NaN values from all applicable DataPackage components.</span>

<span class="sd">        Iterates through the bulk data, annotation data, and multi-modal</span>
<span class="sd">        single-cell data (MuData and AnnData objects) within the provided</span>
<span class="sd">        DataPackage and removes rows/columns/entries containing NaN values.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The DataPackage object containing multi-modal data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The DataPackage object with NaN values removed from its components.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle bulk data</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_bulk</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_bulk</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">data</span><span class="o">.</span><span class="n">multi_bulk</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Handle annotation data</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">non_na</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_cols</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                            <span class="n">v</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">non_na</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">data</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">non_na</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Handle MuData in multi_sc</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">requires_paired</span><span class="p">:</span>
            <span class="n">mudata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span><span class="p">[</span><span class="s2">&quot;multi_sc&quot;</span><span class="p">]</span>
            <span class="c1"># Process each modality</span>
            <span class="k">for</span> <span class="n">mod_name</span><span class="p">,</span> <span class="n">mod_data</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">processed_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_modality</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">mod_data</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span><span class="p">[</span><span class="s2">&quot;multi_sc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_mod</span>

        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data in multi_sc: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">processed</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># we know from screader that there is only one modality</span>
                <span class="k">for</span> <span class="n">modkey</span><span class="p">,</span> <span class="n">adata</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">processed_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_modality</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">)</span>
                    <span class="n">processed_mod</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">MuData</span><span class="p">({</span><span class="n">modkey</span><span class="p">:</span> <span class="n">processed_mod</span><span class="p">})</span>
                <span class="n">processed</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_mod</span>
            <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span> <span class="o">=</span> <span class="n">processed</span>

        <span class="c1"># Handle from_modality and to_modality (for translation cases)</span>
        <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;from_modality&quot;</span><span class="p">,</span> <span class="s2">&quot;to_modality&quot;</span><span class="p">]:</span>
            <span class="n">modality_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">modality_dict</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">mod_key</span><span class="p">,</span> <span class="n">mod_value</span> <span class="ow">in</span> <span class="n">modality_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Handle MuData objects - use the proper import</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod_value</span><span class="p">,</span> <span class="n">md</span><span class="o">.</span><span class="n">MuData</span><span class="p">):</span>
                    <span class="c1"># Process each modality in the MuData</span>
                    <span class="k">for</span> <span class="n">inner_mod_name</span><span class="p">,</span> <span class="n">inner_mod_data</span> <span class="ow">in</span> <span class="n">mod_value</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">processed_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_modality</span><span class="p">(</span><span class="n">inner_mod_data</span><span class="p">)</span>
                        <span class="n">mod_value</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">inner_mod_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_mod</span>

                    <span class="c1"># Ensure cell alignment if there are multiple modalities</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mod_value</span><span class="o">.</span><span class="n">mod</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">common_cells</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                            <span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                                <span class="o">*</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">obs_names</span><span class="p">)</span> <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">mod_value</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">mod_value</span> <span class="o">=</span> <span class="n">mod_value</span><span class="p">[</span><span class="n">common_cells</span><span class="p">]</span>

                    <span class="n">modality_dict</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_value</span>

                <span class="c1"># Handle AnnData objects directly</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod_value</span><span class="p">,</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">):</span>
                    <span class="n">processed_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_modality</span><span class="p">(</span><span class="n">mod_value</span><span class="p">)</span>
                    <span class="n">modality_dict</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_mod</span>

                <span class="c1"># Handle other types of data (e.g., dictionaries of AnnData objects)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">sub_key</span><span class="p">,</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">mod_value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub_value</span><span class="p">,</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">):</span>
                            <span class="n">processed_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_modality</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span>
                            <span class="n">mod_value</span><span class="p">[</span><span class="n">sub_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_mod</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod_value</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                    <span class="n">mod_value</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">modality_dict</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_value</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Skipping unknown type in </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">mod_key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">mod_value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.NaNRemover.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the NaNRemover with configuration settings.
Args:
    config: Configuration object containing settings for data processing.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_nanremover.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the NaNRemover with configuration settings.</span>
<span class="sd">    Args:</span>
<span class="sd">        config: Configuration object containing settings for data processing.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">relevant_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_config</span><span class="o">.</span><span class="n">annotation_columns</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.NaNRemover.remove_nan" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">remove_nan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Removes NaN values from all applicable DataPackage components.</p>
<p>Iterates through the bulk data, annotation data, and multi-modal
single-cell data (MuData and AnnData objects) within the provided
DataPackage and removes rows/columns/entries containing NaN values.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DataPackage


  
      dataclass
   (autoencodix.data.datapackage.DataPackage)" href="#autoencodix.data.DataPackage">DataPackage</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The DataPackage object containing multi-modal data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="DataPackage


  
      dataclass
   (autoencodix.data.datapackage.DataPackage)" href="#autoencodix.data.DataPackage">DataPackage</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The DataPackage object with NaN values removed from its components.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_nanremover.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_nan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataPackage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataPackage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removes NaN values from all applicable DataPackage components.</span>

<span class="sd">    Iterates through the bulk data, annotation data, and multi-modal</span>
<span class="sd">    single-cell data (MuData and AnnData objects) within the provided</span>
<span class="sd">    DataPackage and removes rows/columns/entries containing NaN values.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The DataPackage object containing multi-modal data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The DataPackage object with NaN values removed from its components.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Handle bulk data</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_bulk</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_bulk</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data</span><span class="o">.</span><span class="n">multi_bulk</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Handle annotation data</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">non_na</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relevant_cols</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">v</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">non_na</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">data</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">non_na</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># Handle MuData in multi_sc</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">requires_paired</span><span class="p">:</span>
        <span class="n">mudata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span><span class="p">[</span><span class="s2">&quot;multi_sc&quot;</span><span class="p">]</span>
        <span class="c1"># Process each modality</span>
        <span class="k">for</span> <span class="n">mod_name</span><span class="p">,</span> <span class="n">mod_data</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">processed_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_modality</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">mod_data</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span><span class="p">[</span><span class="s2">&quot;multi_sc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_mod</span>

    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data in multi_sc: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># we know from screader that there is only one modality</span>
            <span class="k">for</span> <span class="n">modkey</span><span class="p">,</span> <span class="n">adata</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">processed_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_modality</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">)</span>
                <span class="n">processed_mod</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">MuData</span><span class="p">({</span><span class="n">modkey</span><span class="p">:</span> <span class="n">processed_mod</span><span class="p">})</span>
            <span class="n">processed</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_mod</span>
        <span class="n">data</span><span class="o">.</span><span class="n">multi_sc</span> <span class="o">=</span> <span class="n">processed</span>

    <span class="c1"># Handle from_modality and to_modality (for translation cases)</span>
    <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;from_modality&quot;</span><span class="p">,</span> <span class="s2">&quot;to_modality&quot;</span><span class="p">]:</span>
        <span class="n">modality_dict</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">modality_dict</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">mod_key</span><span class="p">,</span> <span class="n">mod_value</span> <span class="ow">in</span> <span class="n">modality_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Handle MuData objects - use the proper import</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod_value</span><span class="p">,</span> <span class="n">md</span><span class="o">.</span><span class="n">MuData</span><span class="p">):</span>
                <span class="c1"># Process each modality in the MuData</span>
                <span class="k">for</span> <span class="n">inner_mod_name</span><span class="p">,</span> <span class="n">inner_mod_data</span> <span class="ow">in</span> <span class="n">mod_value</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">processed_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_modality</span><span class="p">(</span><span class="n">inner_mod_data</span><span class="p">)</span>
                    <span class="n">mod_value</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">inner_mod_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_mod</span>

                <span class="c1"># Ensure cell alignment if there are multiple modalities</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mod_value</span><span class="o">.</span><span class="n">mod</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">common_cells</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                            <span class="o">*</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">obs_names</span><span class="p">)</span> <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">mod_value</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">mod_value</span> <span class="o">=</span> <span class="n">mod_value</span><span class="p">[</span><span class="n">common_cells</span><span class="p">]</span>

                <span class="n">modality_dict</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_value</span>

            <span class="c1"># Handle AnnData objects directly</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod_value</span><span class="p">,</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">):</span>
                <span class="n">processed_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_modality</span><span class="p">(</span><span class="n">mod_value</span><span class="p">)</span>
                <span class="n">modality_dict</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_mod</span>

            <span class="c1"># Handle other types of data (e.g., dictionaries of AnnData objects)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">sub_key</span><span class="p">,</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">mod_value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub_value</span><span class="p">,</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">):</span>
                        <span class="n">processed_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_modality</span><span class="p">(</span><span class="n">sub_value</span><span class="p">)</span>
                        <span class="n">mod_value</span><span class="p">[</span><span class="n">sub_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_mod</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod_value</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">mod_value</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">modality_dict</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_value</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Skipping unknown type in </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">mod_key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">mod_value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.NumericDataset" class="doc doc-heading">
            <code>NumericDataset</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="TensorAwareDataset (autoencodix.data._numeric_dataset.TensorAwareDataset)" href="#autoencodix.data.TensorAwareDataset">TensorAwareDataset</a></code></p>


        <p>A custom PyTorch dataset that handles tensors.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.NumericDataset.data">data</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input features as a torch.Tensor.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.NumericDataset.config">config</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object containing settings for data processing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.NumericDataset.sample_ids">sample_ids</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of sample identifiers.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.NumericDataset.feature_ids">feature_ids</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of feature identifiers.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.NumericDataset.metadata">metadata</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional pandas DataFrame containing metadata.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.NumericDataset.split_indices">split_indices</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional numpy array for data splitting.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.NumericDataset.mytype">mytype</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Enum indicating the dataset type (set to DataSetTypes.NUM).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_numeric_dataset.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NumericDataset</span><span class="p">(</span><span class="n">TensorAwareDataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom PyTorch dataset that handles tensors.</span>


<span class="sd">    Attributes:</span>
<span class="sd">        data: The input features as a torch.Tensor.</span>
<span class="sd">        config: Configuration object containing settings for data processing.</span>
<span class="sd">        sample_ids: Optional list of sample identifiers.</span>
<span class="sd">        feature_ids: Optional list of feature identifiers.</span>
<span class="sd">        metadata: Optional pandas DataFrame containing metadata.</span>
<span class="sd">        split_indices: Optional numpy array for data splitting.</span>
<span class="sd">        mytype: Enum indicating the dataset type (set to DataSetTypes.NUM).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span>
        <span class="n">sample_ids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_ids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">split_indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the dataset</span>

<span class="sd">        Args:</span>
<span class="sd">            data: Input features</span>
<span class="sd">            config: Configuration object</span>
<span class="sd">            sample_ids: Optional sample identifiers</span>
<span class="sd">            feature_ids: Optional feature identifiers</span>
<span class="sd">            metadata: Optional metadata</span>
<span class="sd">            split_indices: Optional split indices</span>
<span class="sd">            Optional split indices</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">sample_ids</span><span class="o">=</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">feature_ids</span><span class="o">=</span><span class="n">feature_ids</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;config cannot be None&quot;</span><span class="p">)</span>

        <span class="c1"># Convert data to appropriate dtype once during initialization</span>
        <span class="n">target_dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_target_dtype</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_tensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_dtype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_indices</span> <span class="o">=</span> <span class="n">split_indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mytype</span> <span class="o">=</span> <span class="n">DataSetTypes</span><span class="o">.</span><span class="n">NUM</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of samples (rows) in the dataset&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.NumericDataset.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">sample_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">split_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the dataset</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input features</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DefaultConfig (autoencodix.configs.default_config.DefaultConfig)" href="../configs/#autoencodix.configs.DefaultConfig">DefaultConfig</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample_ids</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[None, <span title="typing.List">List</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional sample identifiers</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>feature_ids</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[None, <span title="typing.List">List</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional feature identifiers</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metadata</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="pandas.Series">Series</span>, <span title="pandas.DataFrame">DataFrame</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional metadata</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>split_indices</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>], <span title="typing.List">List</span>[<span title="typing.Any">Any</span>], <span title="numpy.ndarray">ndarray</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional split indices</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_numeric_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span>
    <span class="n">sample_ids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">feature_ids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">split_indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the dataset</span>

<span class="sd">    Args:</span>
<span class="sd">        data: Input features</span>
<span class="sd">        config: Configuration object</span>
<span class="sd">        sample_ids: Optional sample identifiers</span>
<span class="sd">        feature_ids: Optional feature identifiers</span>
<span class="sd">        metadata: Optional metadata</span>
<span class="sd">        split_indices: Optional split indices</span>
<span class="sd">        Optional split indices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">sample_ids</span><span class="o">=</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">feature_ids</span><span class="o">=</span><span class="n">feature_ids</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;config cannot be None&quot;</span><span class="p">)</span>

    <span class="c1"># Convert data to appropriate dtype once during initialization</span>
    <span class="n">target_dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_target_dtype</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_tensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target_dtype</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">split_indices</span> <span class="o">=</span> <span class="n">split_indices</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mytype</span> <span class="o">=</span> <span class="n">DataSetTypes</span><span class="o">.</span><span class="n">NUM</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.NumericDataset.__len__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__len__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns the number of samples (rows) in the dataset</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_numeric_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the number of samples (rows) in the dataset&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.SingleCellFilter" class="doc doc-heading">
            <code>SingleCellFilter</code>


</h2>


    <div class="doc doc-contents ">


        <p>Filter and scale single-cell data, returning a MuData object with synchronized metadata.AnnData</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.SingleCellFilter.data_info">data_info</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for filtering and scaling (can be a single DataInfo or a dict of DataInfo per modality).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.SingleCellFilter.total_features">total_features</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total number of features to keep across all modalities.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.SingleCellFilter.config">config</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object containing settings for data processing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.SingleCellFilter._is_data_info_dict">_is_data_info_dict</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Internal flag indicating if data_info is a dictionary.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_sc_filter.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SingleCellFilter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter and scale single-cell data, returning a MuData object with synchronized metadata.AnnData</span>

<span class="sd">    Attributes:</span>
<span class="sd">        data_info: Configuration for filtering and scaling (can be a single DataInfo or a dict of DataInfo per modality).</span>
<span class="sd">        total_features: Total number of features to keep across all modalities.</span>
<span class="sd">        config: Configuration object containing settings for data processing.</span>
<span class="sd">        _is_data_info_dict: Internal flag indicating if data_info is a dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">data_info</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DataInfo</span><span class="p">],</span> <span class="n">DataInfo</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize single-cell filter.</span>
<span class="sd">        Args:</span>
<span class="sd">            data_info: Either a single data_info object for all modalities or a dictionary of data_info objects for each modality.</span>
<span class="sd">            config: Configuration object containing settings for data processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span> <span class="o">=</span> <span class="n">data_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_features</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">k_filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_data_info_dict</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_data_info_for_modality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mod_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the data_info configuration for a specific modality.</span>
<span class="sd">        Args:</span>
<span class="sd">            mod_key: The modality key (e.g., &quot;RNA&quot;, &quot;METH&quot;)</span>
<span class="sd">        Returns</span>
<span class="sd">            The data_info configuration for the modality</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_data_info_dict</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mod_key</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data info found for modality </span><span class="si">{</span><span class="n">mod_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">info</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_layers_for_modality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mod_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the layers to process for a specific modality.</span>
<span class="sd">        Args</span>
<span class="sd">            mod_key: The modality key (e.g., &quot;RNA&quot;, &quot;METH&quot;)</span>
<span class="sd">            mod_data: The AnnData object for the modality</span>
<span class="sd">        Returns</span>
<span class="sd">            List of layer names to process. If None or empty, returns [&#39;X&#39;] for default layer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_info_for_modality</span><span class="p">(</span><span class="n">mod_key</span><span class="p">)</span>
        <span class="n">selected_layers</span> <span class="o">=</span> <span class="n">data_info</span><span class="o">.</span><span class="n">selected_layers</span>

        <span class="c1"># Validate that the specified layers exist</span>
        <span class="n">available_layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mod_data</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">valid_layers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">selected_layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
                <span class="n">valid_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">available_layers</span><span class="p">:</span>
                <span class="n">valid_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: Layer &#39;</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">&#39; not found in modality &#39;</span><span class="si">{</span><span class="n">mod_key</span><span class="si">}</span><span class="s2">&#39;. Skipping.&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_layers</span><span class="p">:</span>
            <span class="n">valid_layers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">valid_layers</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_presplit_processing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mudata</span><span class="p">:</span> <span class="n">MuData</span><span class="p">,</span>  <span class="c1"># type: ignore[invalid-type-form]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MuData</span><span class="p">:</span>  <span class="c1"># type: ignore[invalid-type-form]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocess the data using modality-specific configurations.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Preprocessed data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mudata: </span><span class="si">{</span><span class="n">mudata</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mod_key</span><span class="p">,</span> <span class="n">mod_data</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_info_for_modality</span><span class="p">(</span><span class="n">mod_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">filter_cells</span><span class="p">(</span><span class="n">mod_data</span><span class="p">,</span> <span class="n">min_genes</span><span class="o">=</span><span class="n">data_info</span><span class="o">.</span><span class="n">min_genes</span><span class="p">)</span>
                <span class="n">layers_to_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_layers_for_modality</span><span class="p">(</span><span class="n">mod_key</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers_to_process</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">data_info</span><span class="o">.</span><span class="n">log_transform</span><span class="p">:</span>
                            <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">mod_data</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">temp_view</span> <span class="o">=</span> <span class="n">mod_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">temp_view</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">mod_data</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">data_info</span><span class="o">.</span><span class="n">log_transform</span><span class="p">:</span>
                            <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">temp_view</span><span class="p">)</span>
                        <span class="n">mod_data</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_view</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_data</span>

        <span class="k">return</span> <span class="n">mudata</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">presplit_processing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">multi_sc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">MuData</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MuData</span><span class="p">]],</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MuData</span><span class="p">]:</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process each modality independently to filter cells based on min_genes.</span>

<span class="sd">        Args:</span>
<span class="sd">            multi_sc: Either a single MuData object or a dictionary of MuData objects.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A dictionary mapping modality keys to processed MuData objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">mudata</span><span class="w"> </span><span class="kn">import</span> <span class="n">MuData</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">multi_sc</span><span class="p">,</span> <span class="n">MuData</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presplit_processing</span><span class="p">(</span><span class="n">mudata</span><span class="o">=</span><span class="n">multi_sc</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">multi_sc</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">multi_sc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presplit_processing</span><span class="p">(</span><span class="n">mudata</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a modality&#39;s AnnData object to a pandas DataFrame.</span>
<span class="sd">        Args:</span>
<span class="sd">            mod_data: Modality data to be transformed</span>
<span class="sd">            layer: Layer to convert to DataFrame. If None, uses X.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Transformed DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">layer</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">mod_data</span><span class="o">.</span><span class="n">X</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">mod_data</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>

        <span class="c1"># Convert to dense array if sparse</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Assuming it&#39;s a sparse matrix</span>
            <span class="n">matrix</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">matrix</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">mod_data</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">mod_data</span><span class="o">.</span><span class="n">obs_names</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_from_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update a modality&#39;s AnnData object with the values from a DataFrame.</span>
<span class="sd">        This also synchronizes the `obs` and `var` metadata to match the filtered data.</span>
<span class="sd">        Args:</span>
<span class="sd">            df: DataFrame containing the updated values</span>
<span class="sd">            mod_data: Modality data to be updated</span>
<span class="sd">            layer: Layer to update with DataFrame values. If None, updates X.</span>
<span class="sd">        Returns:</span>
<span class="sd">            Updated AnnData object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Filter the AnnData object to match the rows and columns of the DataFrame</span>
        <span class="n">filtered_mod_data</span> <span class="o">=</span> <span class="n">mod_data</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Update the data matrix with the filtered and scaled values</span>
        <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">layer</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
            <span class="n">filtered_mod_data</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_mod_data</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="n">filtered_mod_data</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filtered_mod_data</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span>

        <span class="k">return</span> <span class="n">filtered_mod_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sc_postsplit_processing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mudata</span><span class="p">:</span> <span class="n">MuData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
        <span class="n">gene_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">MuData</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process each modality independently to filter genes based on X layer, then</span>
<span class="sd">        consistently apply the same filtering to all layers.</span>

<span class="sd">        Args:</span>
<span class="sd">        mudata : Input multi-modal data container</span>
<span class="sd">        gene_map : Optional override of genes to keep per modality</span>

<span class="sd">        Returns:</span>
<span class="sd">            - Processed MuData with filtered modalities</span>
<span class="sd">            - Mapping of modality to kept gene names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kept_genes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">processed_mods</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">mod_key</span><span class="p">,</span> <span class="n">adata</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Get configuration for this modality</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_info_for_modality</span><span class="p">(</span><span class="n">mod_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data info for modality &#39;</span><span class="si">{</span><span class="n">mod_key</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="c1"># Determine which genes to keep</span>
            <span class="k">if</span> <span class="n">gene_map</span> <span class="ow">and</span> <span class="n">mod_key</span> <span class="ow">in</span> <span class="n">gene_map</span><span class="p">:</span>
                <span class="c1"># Use provided gene list if available</span>
                <span class="n">genes_to_keep</span> <span class="o">=</span> <span class="n">gene_map</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span>
                <span class="n">var_mask</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">genes_to_keep</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Filter genes based on minimum cells expressing each gene</span>
                <span class="n">var_mask</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">filter_genes</span><span class="p">(</span>
                    <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">min_cells</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">min_cells</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">genes_to_keep</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">[</span><span class="n">var_mask</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="n">kept_genes</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">genes_to_keep</span>

            <span class="c1"># Create new AnnData with filtered X layer</span>
            <span class="n">filtered_adata</span> <span class="o">=</span> <span class="n">AnnData</span><span class="p">(</span>
                <span class="n">X</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">var_mask</span><span class="p">],</span>
                <span class="n">obs</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="n">var</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="n">var_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="n">uns</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="n">obsm</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="p">)</span>

            <span class="c1"># Normalize if configured</span>
            <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">normalize_counts</span><span class="p">:</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">filtered_adata</span><span class="p">)</span>

            <span class="c1"># Copy filtered layers</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_layers_for_modality</span><span class="p">(</span><span class="n">mod_key</span><span class="p">,</span> <span class="n">adata</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">layer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Layer &#39;</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">&#39; not found in modality &#39;</span><span class="si">{</span><span class="n">mod_key</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>

                <span class="n">filtered_adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">][:,</span> <span class="n">var_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">processed_mods</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_adata</span>

        <span class="c1"># Construct new MuData from filtered modalities</span>
        <span class="k">return</span> <span class="n">md</span><span class="o">.</span><span class="n">MuData</span><span class="p">(</span><span class="n">processed_mods</span><span class="p">),</span> <span class="n">kept_genes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_general_filtering</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">data_info</span><span class="p">:</span> <span class="n">DataInfo</span><span class="p">,</span> <span class="n">gene_list</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">List</span><span class="p">]:</span>
        <span class="n">data_processor</span> <span class="o">=</span> <span class="n">DataFilter</span><span class="p">(</span><span class="n">data_info</span><span class="o">=</span><span class="n">data_info</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data_processor</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">genes_to_keep</span><span class="o">=</span><span class="n">gene_list</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_scaling</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">data_info</span><span class="p">:</span> <span class="n">DataInfo</span><span class="p">,</span> <span class="n">scaler</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">data_processor</span> <span class="o">=</span> <span class="n">DataFilter</span><span class="p">(</span><span class="n">data_info</span><span class="o">=</span><span class="n">data_info</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scaler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">data_processor</span><span class="o">.</span><span class="n">fit_scaler</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="n">scaled_df</span> <span class="o">=</span> <span class="n">data_processor</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="n">scaler</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scaled_df</span><span class="p">,</span> <span class="n">scaler</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">general_postsplit_processing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mudata</span><span class="p">:</span> <span class="n">MuData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
        <span class="n">gene_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]],</span>
        <span class="n">scaler_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">MuData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
        <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">],</span>
        <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
    <span class="p">]:</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process single-cell data with proper MuData handling</span>
<span class="sd">        Args:</span>
<span class="sd">            mudata: Input multi-modal data container</span>
<span class="sd">            gene_map: Optional override of genes to keep per modality</span>
<span class="sd">            scaler_map: Optional pre-fitted scalers per modality and layer</span>
<span class="sd">        Returns:</span>
<span class="sd">            Processed MuData with filtered and scaled modalities,</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">feature_distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribute_features_across_modalities</span><span class="p">(</span>
            <span class="n">mudata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_features</span>
        <span class="p">)</span>
        <span class="n">out_gene_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">out_scaler_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">mod_key</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">mod_key</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

        <span class="c1"># Dictionary to store processed modalities</span>
        <span class="n">processed_modalities</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">mod_key</span><span class="p">,</span> <span class="n">original_mod</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_info_for_modality</span><span class="p">(</span><span class="n">mod_key</span><span class="p">)</span>
            <span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span> <span class="o">=</span> <span class="n">feature_distribution</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">data_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data info found for modality </span><span class="si">{</span><span class="n">mod_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Create working copy of the modality data</span>
            <span class="n">mod_data</span> <span class="o">=</span> <span class="n">original_mod</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Process X matrix</span>
            <span class="n">x_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_dataframe</span><span class="p">(</span><span class="n">mod_data</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">filtered_x</span><span class="p">,</span> <span class="n">gene_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_general_filtering</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">x_df</span><span class="p">,</span>
                <span class="n">gene_list</span><span class="o">=</span><span class="n">gene_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mod_key</span><span class="p">)</span> <span class="k">if</span> <span class="n">gene_map</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">data_info</span><span class="o">=</span><span class="n">data_info</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">out_gene_map</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_list</span>

            <span class="c1"># Apply scaling to X</span>
            <span class="n">scaled_x</span><span class="p">,</span> <span class="n">x_scaler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_scaling</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">filtered_x</span><span class="p">,</span>
                <span class="n">data_info</span><span class="o">=</span><span class="n">data_info</span><span class="p">,</span>
                <span class="n">scaler</span><span class="o">=</span><span class="n">scaler_map</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">scaler_map</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">out_scaler_map</span><span class="p">[</span><span class="n">mod_key</span><span class="p">][</span><span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_scaler</span>

            <span class="c1"># Create new AnnData for this modality</span>
            <span class="n">processed_adata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_new_adata</span><span class="p">(</span>
                <span class="n">scaled_x</span><span class="p">,</span>
                <span class="n">original_adata</span><span class="o">=</span><span class="n">mod_data</span><span class="p">,</span>
                <span class="n">obs_names</span><span class="o">=</span><span class="n">mod_data</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="n">var_names</span><span class="o">=</span><span class="n">filtered_x</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="p">)</span>

            <span class="c1"># Process layers</span>
            <span class="n">layers_to_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_layers_for_modality</span><span class="p">(</span><span class="n">mod_key</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers_to_process</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Process layer data</span>
                <span class="n">layer_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_dataframe</span><span class="p">(</span><span class="n">mod_data</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
                <span class="n">filtered_layer</span> <span class="o">=</span> <span class="n">layer_df</span><span class="p">[</span><span class="n">filtered_x</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>  <span class="c1"># Match X&#39;s columns</span>

                <span class="c1"># Apply scaling with same genes as X</span>
                <span class="n">scaled_layer</span><span class="p">,</span> <span class="n">layer_scaler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_scaling</span><span class="p">(</span>
                    <span class="n">df</span><span class="o">=</span><span class="n">filtered_layer</span><span class="p">,</span>
                    <span class="n">data_info</span><span class="o">=</span><span class="n">data_info</span><span class="p">,</span>
                    <span class="n">scaler</span><span class="o">=</span><span class="n">scaler_map</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="k">if</span> <span class="n">scaler_map</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">out_scaler_map</span><span class="p">[</span><span class="n">mod_key</span><span class="p">][</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_scaler</span>

                <span class="c1"># Store in new AnnData</span>
                <span class="n">processed_adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_layer</span><span class="o">.</span><span class="n">values</span>

            <span class="c1"># Store processed modality</span>
            <span class="n">processed_modalities</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_adata</span>

        <span class="c1"># Create new MuData from processed modalities</span>
        <span class="n">new_mudata</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">MuData</span><span class="p">(</span><span class="n">processed_modalities</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_mudata</span><span class="p">,</span> <span class="n">out_gene_map</span><span class="p">,</span> <span class="n">out_scaler_map</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_new_adata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">original_adata</span><span class="p">,</span> <span class="n">obs_names</span><span class="p">,</span> <span class="n">var_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to create properly structured AnnData&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">AnnData</span><span class="p">(</span>
            <span class="n">X</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">obs</span><span class="o">=</span><span class="n">original_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">obs_names</span><span class="p">],</span>
            <span class="n">var</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">var_names</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">uns</span><span class="o">=</span><span class="n">original_adata</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">obsm</span><span class="o">=</span><span class="n">original_adata</span><span class="o">.</span><span class="n">obsm</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">varm</span><span class="o">=</span><span class="n">original_adata</span><span class="o">.</span><span class="n">varm</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">distribute_features_across_modalities</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mudata</span><span class="p">:</span> <span class="n">MuData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
        <span class="n">total_features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Distributes a total number of features across modalities evenly.</span>

<span class="sd">        Args:</span>
<span class="sd">            mudata: Multi-modal data object</span>
<span class="sd">            total_features: Total number of features to distribute across all modalities</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary mapping modality keys to number of features to keep</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">valid_modalities</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">total_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_modalities</span><span class="p">}</span>
        <span class="n">n_modalities</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_modalities</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_modalities</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">base_features</span> <span class="o">=</span> <span class="n">total_features</span> <span class="o">//</span> <span class="n">n_modalities</span>
        <span class="n">remainder</span> <span class="o">=</span> <span class="n">total_features</span> <span class="o">%</span> <span class="n">n_modalities</span>

        <span class="c1"># Distribute features</span>
        <span class="n">feature_distribution</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mod_key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid_modalities</span><span class="p">):</span>
            <span class="c1"># Add one extra feature to early modalities if there&#39;s remainder</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">remainder</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">feature_distribution</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_features</span> <span class="o">+</span> <span class="n">extra</span>

            <span class="c1"># Set k_filter in data_info if available</span>
            <span class="n">data_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_info_for_modality</span><span class="p">(</span><span class="n">mod_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data_info</span><span class="p">,</span> <span class="s2">&quot;k_filter&quot;</span><span class="p">):</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">data_info</span><span class="p">,</span> <span class="s2">&quot;k_filter&quot;</span><span class="p">,</span> <span class="n">feature_distribution</span><span class="p">[</span><span class="n">mod_key</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span> <span class="o">=</span> <span class="n">feature_distribution</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">feature_distribution</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.SingleCellFilter.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">data_info</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize single-cell filter.
Args:
    data_info: Either a single data_info object for all modalities or a dictionary of data_info objects for each modality.
    config: Configuration object containing settings for data processing.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_sc_filter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">data_info</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DataInfo</span><span class="p">],</span> <span class="n">DataInfo</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize single-cell filter.</span>
<span class="sd">    Args:</span>
<span class="sd">        data_info: Either a single data_info object for all modalities or a dictionary of data_info objects for each modality.</span>
<span class="sd">        config: Configuration object containing settings for data processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_info</span> <span class="o">=</span> <span class="n">data_info</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">total_features</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">k_filter</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_is_data_info_dict</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.SingleCellFilter.distribute_features_across_modalities" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">distribute_features_across_modalities</span><span class="p">(</span><span class="n">mudata</span><span class="p">,</span> <span class="n">total_features</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Distributes a total number of features across modalities evenly.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mudata</code>
            </td>
            <td>
                  <code><span title="autoencodix.data._sc_filter.MuData">MuData</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multi-modal data object</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>total_features</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total number of features to distribute across all modalities</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping modality keys to number of features to keep</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_sc_filter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">distribute_features_across_modalities</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">mudata</span><span class="p">:</span> <span class="n">MuData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
    <span class="n">total_features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Distributes a total number of features across modalities evenly.</span>

<span class="sd">    Args:</span>
<span class="sd">        mudata: Multi-modal data object</span>
<span class="sd">        total_features: Total number of features to distribute across all modalities</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping modality keys to number of features to keep</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">valid_modalities</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">total_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_modalities</span><span class="p">}</span>
    <span class="n">n_modalities</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_modalities</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_modalities</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">base_features</span> <span class="o">=</span> <span class="n">total_features</span> <span class="o">//</span> <span class="n">n_modalities</span>
    <span class="n">remainder</span> <span class="o">=</span> <span class="n">total_features</span> <span class="o">%</span> <span class="n">n_modalities</span>

    <span class="c1"># Distribute features</span>
    <span class="n">feature_distribution</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mod_key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid_modalities</span><span class="p">):</span>
        <span class="c1"># Add one extra feature to early modalities if there&#39;s remainder</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">remainder</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">feature_distribution</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_features</span> <span class="o">+</span> <span class="n">extra</span>

        <span class="c1"># Set k_filter in data_info if available</span>
        <span class="n">data_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_info_for_modality</span><span class="p">(</span><span class="n">mod_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data_info</span><span class="p">,</span> <span class="s2">&quot;k_filter&quot;</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">data_info</span><span class="p">,</span> <span class="s2">&quot;k_filter&quot;</span><span class="p">,</span> <span class="n">feature_distribution</span><span class="p">[</span><span class="n">mod_key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span> <span class="o">=</span> <span class="n">feature_distribution</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">feature_distribution</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.SingleCellFilter.general_postsplit_processing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">general_postsplit_processing</span><span class="p">(</span><span class="n">mudata</span><span class="p">,</span> <span class="n">gene_map</span><span class="p">,</span> <span class="n">scaler_map</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Process single-cell data with proper MuData handling
Args:
    mudata: Input multi-modal data container
    gene_map: Optional override of genes to keep per modality
    scaler_map: Optional pre-fitted scalers per modality and layer
Returns:
    Processed MuData with filtered and scaled modalities,</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_sc_filter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">general_postsplit_processing</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">mudata</span><span class="p">:</span> <span class="n">MuData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
    <span class="n">gene_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]],</span>
    <span class="n">scaler_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">MuData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
    <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">],</span>
    <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
<span class="p">]:</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process single-cell data with proper MuData handling</span>
<span class="sd">    Args:</span>
<span class="sd">        mudata: Input multi-modal data container</span>
<span class="sd">        gene_map: Optional override of genes to keep per modality</span>
<span class="sd">        scaler_map: Optional pre-fitted scalers per modality and layer</span>
<span class="sd">    Returns:</span>
<span class="sd">        Processed MuData with filtered and scaled modalities,</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">feature_distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribute_features_across_modalities</span><span class="p">(</span>
        <span class="n">mudata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_features</span>
    <span class="p">)</span>
    <span class="n">out_gene_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">out_scaler_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">mod_key</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">mod_key</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

    <span class="c1"># Dictionary to store processed modalities</span>
    <span class="n">processed_modalities</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">mod_key</span><span class="p">,</span> <span class="n">original_mod</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">data_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_info_for_modality</span><span class="p">(</span><span class="n">mod_key</span><span class="p">)</span>
        <span class="n">data_info</span><span class="o">.</span><span class="n">k_filter</span> <span class="o">=</span> <span class="n">feature_distribution</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">data_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data info found for modality </span><span class="si">{</span><span class="n">mod_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create working copy of the modality data</span>
        <span class="n">mod_data</span> <span class="o">=</span> <span class="n">original_mod</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Process X matrix</span>
        <span class="n">x_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_dataframe</span><span class="p">(</span><span class="n">mod_data</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">filtered_x</span><span class="p">,</span> <span class="n">gene_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_general_filtering</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">x_df</span><span class="p">,</span>
            <span class="n">gene_list</span><span class="o">=</span><span class="n">gene_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mod_key</span><span class="p">)</span> <span class="k">if</span> <span class="n">gene_map</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">data_info</span><span class="o">=</span><span class="n">data_info</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">out_gene_map</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_list</span>

        <span class="c1"># Apply scaling to X</span>
        <span class="n">scaled_x</span><span class="p">,</span> <span class="n">x_scaler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_scaling</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">filtered_x</span><span class="p">,</span>
            <span class="n">data_info</span><span class="o">=</span><span class="n">data_info</span><span class="p">,</span>
            <span class="n">scaler</span><span class="o">=</span><span class="n">scaler_map</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">scaler_map</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">out_scaler_map</span><span class="p">[</span><span class="n">mod_key</span><span class="p">][</span><span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_scaler</span>

        <span class="c1"># Create new AnnData for this modality</span>
        <span class="n">processed_adata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_new_adata</span><span class="p">(</span>
            <span class="n">scaled_x</span><span class="p">,</span>
            <span class="n">original_adata</span><span class="o">=</span><span class="n">mod_data</span><span class="p">,</span>
            <span class="n">obs_names</span><span class="o">=</span><span class="n">mod_data</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="n">var_names</span><span class="o">=</span><span class="n">filtered_x</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="c1"># Process layers</span>
        <span class="n">layers_to_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_layers_for_modality</span><span class="p">(</span><span class="n">mod_key</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers_to_process</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Process layer data</span>
            <span class="n">layer_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_dataframe</span><span class="p">(</span><span class="n">mod_data</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
            <span class="n">filtered_layer</span> <span class="o">=</span> <span class="n">layer_df</span><span class="p">[</span><span class="n">filtered_x</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>  <span class="c1"># Match X&#39;s columns</span>

            <span class="c1"># Apply scaling with same genes as X</span>
            <span class="n">scaled_layer</span><span class="p">,</span> <span class="n">layer_scaler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_scaling</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">filtered_layer</span><span class="p">,</span>
                <span class="n">data_info</span><span class="o">=</span><span class="n">data_info</span><span class="p">,</span>
                <span class="n">scaler</span><span class="o">=</span><span class="n">scaler_map</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="k">if</span> <span class="n">scaler_map</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">out_scaler_map</span><span class="p">[</span><span class="n">mod_key</span><span class="p">][</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_scaler</span>

            <span class="c1"># Store in new AnnData</span>
            <span class="n">processed_adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_layer</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Store processed modality</span>
        <span class="n">processed_modalities</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_adata</span>

    <span class="c1"># Create new MuData from processed modalities</span>
    <span class="n">new_mudata</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">MuData</span><span class="p">(</span><span class="n">processed_modalities</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_mudata</span><span class="p">,</span> <span class="n">out_gene_map</span><span class="p">,</span> <span class="n">out_scaler_map</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.SingleCellFilter.presplit_processing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">presplit_processing</span><span class="p">(</span><span class="n">multi_sc</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Process each modality independently to filter cells based on min_genes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>multi_sc</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="autoencodix.data._sc_filter.MuData">MuData</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="autoencodix.data._sc_filter.MuData">MuData</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either a single MuData object or a dictionary of MuData objects.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    A dictionary mapping modality keys to processed MuData objects.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_sc_filter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">presplit_processing</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">multi_sc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">MuData</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MuData</span><span class="p">]],</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MuData</span><span class="p">]:</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process each modality independently to filter cells based on min_genes.</span>

<span class="sd">    Args:</span>
<span class="sd">        multi_sc: Either a single MuData object or a dictionary of MuData objects.</span>
<span class="sd">    Returns:</span>
<span class="sd">        A dictionary mapping modality keys to processed MuData objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">mudata</span><span class="w"> </span><span class="kn">import</span> <span class="n">MuData</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">multi_sc</span><span class="p">,</span> <span class="n">MuData</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presplit_processing</span><span class="p">(</span><span class="n">mudata</span><span class="o">=</span><span class="n">multi_sc</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">multi_sc</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">multi_sc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presplit_processing</span><span class="p">(</span><span class="n">mudata</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.SingleCellFilter.sc_postsplit_processing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sc_postsplit_processing</span><span class="p">(</span><span class="n">mudata</span><span class="p">,</span> <span class="n">gene_map</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Process each modality independently to filter genes based on X layer, then
consistently apply the same filtering to all layers.</p>
<p>Args:
mudata : Input multi-modal data container
gene_map : Optional override of genes to keep per modality</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="autoencodix.data._sc_filter.MuData">MuData</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>Processed MuData with filtered modalities</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>Mapping of modality to kept gene names</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_sc_filter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sc_postsplit_processing</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">mudata</span><span class="p">:</span> <span class="n">MuData</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
    <span class="n">gene_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">MuData</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>  <span class="c1"># ty: ignore[invalid-type-form]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process each modality independently to filter genes based on X layer, then</span>
<span class="sd">    consistently apply the same filtering to all layers.</span>

<span class="sd">    Args:</span>
<span class="sd">    mudata : Input multi-modal data container</span>
<span class="sd">    gene_map : Optional override of genes to keep per modality</span>

<span class="sd">    Returns:</span>
<span class="sd">        - Processed MuData with filtered modalities</span>
<span class="sd">        - Mapping of modality to kept gene names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kept_genes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">processed_mods</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">mod_key</span><span class="p">,</span> <span class="n">adata</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Get configuration for this modality</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_info_for_modality</span><span class="p">(</span><span class="n">mod_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data info for modality &#39;</span><span class="si">{</span><span class="n">mod_key</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Determine which genes to keep</span>
        <span class="k">if</span> <span class="n">gene_map</span> <span class="ow">and</span> <span class="n">mod_key</span> <span class="ow">in</span> <span class="n">gene_map</span><span class="p">:</span>
            <span class="c1"># Use provided gene list if available</span>
            <span class="n">genes_to_keep</span> <span class="o">=</span> <span class="n">gene_map</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span>
            <span class="n">var_mask</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">genes_to_keep</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Filter genes based on minimum cells expressing each gene</span>
            <span class="n">var_mask</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">filter_genes</span><span class="p">(</span>
                <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">min_cells</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">min_cells</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">genes_to_keep</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">[</span><span class="n">var_mask</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">kept_genes</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">genes_to_keep</span>

        <span class="c1"># Create new AnnData with filtered X layer</span>
        <span class="n">filtered_adata</span> <span class="o">=</span> <span class="n">AnnData</span><span class="p">(</span>
            <span class="n">X</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">var_mask</span><span class="p">],</span>
            <span class="n">obs</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">var</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="n">var_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">uns</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">obsm</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="c1"># Normalize if configured</span>
        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">normalize_counts</span><span class="p">:</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">filtered_adata</span><span class="p">)</span>

        <span class="c1"># Copy filtered layers</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_layers_for_modality</span><span class="p">(</span><span class="n">mod_key</span><span class="p">,</span> <span class="n">adata</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">layer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Layer &#39;</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">&#39; not found in modality &#39;</span><span class="si">{</span><span class="n">mod_key</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>

            <span class="n">filtered_adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">][:,</span> <span class="n">var_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">processed_mods</span><span class="p">[</span><span class="n">mod_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_adata</span>

    <span class="c1"># Construct new MuData from filtered modalities</span>
    <span class="k">return</span> <span class="n">md</span><span class="o">.</span><span class="n">MuData</span><span class="p">(</span><span class="n">processed_mods</span><span class="p">),</span> <span class="n">kept_genes</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.StackixDataset" class="doc doc-heading">
            <code>StackixDataset</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="NumericDataset (autoencodix.data._numeric_dataset.NumericDataset)" href="#autoencodix.data.NumericDataset">NumericDataset</a></code></p>


        <p>Dataset for handling multiple modalities in Stackix models.</p>
<p>This dataset holds individual BaseDataset objects for multiple data modalities
and provides a consistent interface for accessing them during training.
It's designed to work specifically with StackixTrainer.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.StackixDataset.dataset_dict">dataset_dict</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping modality names to dataset objects</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.StackixDataset.modality_keys">modality_keys</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of modality names</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_stackix_dataset.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StackixDataset</span><span class="p">(</span><span class="n">NumericDataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dataset for handling multiple modalities in Stackix models.</span>

<span class="sd">    This dataset holds individual BaseDataset objects for multiple data modalities</span>
<span class="sd">    and provides a consistent interface for accessing them during training.</span>
<span class="sd">    It&#39;s designed to work specifically with StackixTrainer.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        dataset_dict: Dictionary mapping modality names to dataset objects</span>
<span class="sd">        modality_keys: List of modality names</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseDataset</span><span class="p">],</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a StackixDataset instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset_dict: Dictionary mapping modality names to dataset objects</span>
<span class="sd">            config: Configuration object</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the datasets dictionary is empty or if modality datasets have different numbers of samples</span>
<span class="sd">            NotImplementedError: If the datasets have incompatible shapes for concatenation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset_dict cannot be empty&quot;</span><span class="p">)</span>

        <span class="c1"># Use first modality for base class initialization</span>
        <span class="n">first_modality_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dataset_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">first_modality</span> <span class="o">=</span> <span class="n">dataset_dict</span><span class="p">[</span><span class="n">first_modality_key</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
                <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataset_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Data modalities have different shapes, set requires_paired=True in config&quot;</span>
            <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">sample_ids</span><span class="o">=</span><span class="n">first_modality</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">split_indices</span><span class="o">=</span><span class="n">first_modality</span><span class="o">.</span><span class="n">split_indices</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">first_modality</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
            <span class="n">feature_ids</span><span class="o">=</span><span class="p">[</span>
                <span class="n">v</span><span class="o">.</span><span class="n">feature_ids</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataset_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;feature_ids&quot;</span><span class="p">)</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dict</span> <span class="o">=</span> <span class="n">dataset_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modality_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Ensure all datasets have the same number of samples</span>
        <span class="n">sample_counts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">dataset_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">sample_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">sample_counts</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;All modality datasets must have the same number of samples&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the number of samples in the dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a single sample and its label from the dataset.</span>

<span class="sd">        Returns the data from the first modality to maintain compatibility</span>
<span class="sd">        with the BaseDataset interface, while still supporting multi-modality</span>
<span class="sd">        access through dataset_dict.</span>
<span class="sd">        Args:</span>
<span class="sd">            index: Index of the sample to retrieve</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of (data tensor, label) pairs for each modality</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_modality_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modality</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a sample for a specific modality.</span>
<span class="sd">        Args:</span>
<span class="sd">            modality: The modality name to retrieve data from</span>
<span class="sd">            index: Index of the sample to retrieve</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (data tensor, label) for the specified modality and sample index</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If the requested modality doesn&#39;t exist in the dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">modality</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Modality &#39;</span><span class="si">{</span><span class="n">modality</span><span class="si">}</span><span class="s2">&#39; not found in dataset&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dict</span><span class="p">[</span><span class="n">modality</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.StackixDataset.__getitem__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get a single sample and its label from the dataset.</p>
<p>Returns the data from the first modality to maintain compatibility
with the BaseDataset interface, while still supporting multi-modality
access through dataset_dict.
Args:
    index: Index of the sample to retrieve</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="typing.Tuple">Tuple</span>[<span title="torch.Tensor">Tensor</span>, <span title="typing.Any">Any</span>], <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Tuple">Tuple</span>[<span title="torch.Tensor">Tensor</span>, <span title="typing.Any">Any</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of (data tensor, label) pairs for each modality</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_stackix_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a single sample and its label from the dataset.</span>

<span class="sd">    Returns the data from the first modality to maintain compatibility</span>
<span class="sd">    with the BaseDataset interface, while still supporting multi-modality</span>
<span class="sd">    access through dataset_dict.</span>
<span class="sd">    Args:</span>
<span class="sd">        index: Index of the sample to retrieve</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary of (data tensor, label) pairs for each modality</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.StackixDataset.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize a StackixDataset instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dataset_dict</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="BaseDataset (autoencodix.base._base_dataset.BaseDataset)" href="../base/#autoencodix.base.BaseDataset">BaseDataset</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping modality names to dataset objects</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DefaultConfig (autoencodix.configs.default_config.DefaultConfig)" href="../configs/#autoencodix.configs.DefaultConfig">DefaultConfig</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the datasets dictionary is empty or if modality datasets have different numbers of samples</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="NotImplementedError">NotImplementedError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the datasets have incompatible shapes for concatenation</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_stackix_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">dataset_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseDataset</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a StackixDataset instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_dict: Dictionary mapping modality names to dataset objects</span>
<span class="sd">        config: Configuration object</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the datasets dictionary is empty or if modality datasets have different numbers of samples</span>
<span class="sd">        NotImplementedError: If the datasets have incompatible shapes for concatenation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataset_dict cannot be empty&quot;</span><span class="p">)</span>

    <span class="c1"># Use first modality for base class initialization</span>
    <span class="n">first_modality_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dataset_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">first_modality</span> <span class="o">=</span> <span class="n">dataset_dict</span><span class="p">[</span><span class="n">first_modality_key</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataset_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Data modalities have different shapes, set requires_paired=True in config&quot;</span>
        <span class="p">)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="n">sample_ids</span><span class="o">=</span><span class="n">first_modality</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="n">split_indices</span><span class="o">=</span><span class="n">first_modality</span><span class="o">.</span><span class="n">split_indices</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="n">first_modality</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">feature_ids</span><span class="o">=</span><span class="p">[</span>
            <span class="n">v</span><span class="o">.</span><span class="n">feature_ids</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataset_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;feature_ids&quot;</span><span class="p">)</span>
        <span class="p">],</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dict</span> <span class="o">=</span> <span class="n">dataset_dict</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">modality_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># Ensure all datasets have the same number of samples</span>
    <span class="n">sample_counts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">dataset_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">sample_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">sample_counts</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;All modality datasets must have the same number of samples&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.StackixDataset.__len__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__len__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return the number of samples in the dataset.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_stackix_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the number of samples in the dataset.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.StackixDataset.get_modality_item" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_modality_item</span><span class="p">(</span><span class="n">modality</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get a sample for a specific modality.
Args:
    modality: The modality name to retrieve data from
    index: Index of the sample to retrieve</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="torch.Tensor">Tensor</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (data tensor, label) for the specified modality and sample index</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="KeyError">KeyError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the requested modality doesn't exist in the dataset</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_stackix_dataset.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_modality_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modality</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a sample for a specific modality.</span>
<span class="sd">    Args:</span>
<span class="sd">        modality: The modality name to retrieve data from</span>
<span class="sd">        index: Index of the sample to retrieve</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (data tensor, label) for the specified modality and sample index</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If the requested modality doesn&#39;t exist in the dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">modality</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Modality &#39;</span><span class="si">{</span><span class="n">modality</span><span class="si">}</span><span class="s2">&#39; not found in dataset&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dict</span><span class="p">[</span><span class="n">modality</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.StackixPreprocessor" class="doc doc-heading">
            <code>StackixPreprocessor</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BasePreprocessor (autoencodix.base._base_preprocessor.BasePreprocessor)" href="../base/#autoencodix.base.BasePreprocessor">BasePreprocessor</a></code></p>


        <p>Preprocessor for Stackix architecture, which handles multiple modalities separately.</p>
<p>Unlike GeneralPreprocessor which combines all modalities, StackixPreprocessor
keeps modalities separate for individual VAE training in the Stackix architecture.</p>
<p>Attributes:
config: Configuration parameters for preprocessing and model architecture
_datapackage: Dictionary storing processed data splits
_dataset_container:Container for processed datasets by split</p>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_stackix_preprocessor.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StackixPreprocessor</span><span class="p">(</span><span class="n">BasePreprocessor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Preprocessor for Stackix architecture, which handles multiple modalities separately.</span>

<span class="sd">    Unlike GeneralPreprocessor which combines all modalities, StackixPreprocessor</span>
<span class="sd">    keeps modalities separate for individual VAE training in the Stackix architecture.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    config: Configuration parameters for preprocessing and model architecture</span>
<span class="sd">    _datapackage: Dictionary storing processed data splits</span>
<span class="sd">    _dataset_container:Container for processed datasets by split</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span> <span class="n">ontologies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the StackixPreprocessor with the given configuration.</span>
<span class="sd">        Args:</span>
<span class="sd">            config: Configuration parameters for preprocessing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datapackage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DatasetContainer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">raw_user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataPackage</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DatasetContainer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute preprocessing steps for Stackix architecture.</span>

<span class="sd">        Args</span>
<span class="sd">        raw_user_data: Raw user data to preprocess, or None to use self._datapackage</span>

<span class="sd">        Returns:</span>
<span class="sd">            Container with StackixDataset for each split</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If datapackage is None after preprocessing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datapackage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_general_preprocess</span><span class="p">(</span><span class="n">raw_user_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span> <span class="o">=</span> <span class="n">DatasetContainer</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">split</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datapackage</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datapackage</span><span class="p">[</span><span class="n">split</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">continue</span>
            <span class="n">dataset_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_dataset_dict</span><span class="p">(</span>
                <span class="n">datapackage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_datapackage</span><span class="p">[</span><span class="n">split</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">],</span>
                <span class="n">split_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_datapackage</span><span class="p">[</span><span class="n">split</span><span class="p">][</span><span class="s2">&quot;indices&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">stackix_ds</span> <span class="o">=</span> <span class="n">MultiModalDataset</span><span class="p">(</span>
                <span class="n">datasets</span><span class="o">=</span><span class="n">dataset_dict</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">stackix_ds</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_primary_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modality_data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">primary_data</span> <span class="o">=</span> <span class="n">modality_data</span><span class="o">.</span><span class="n">X</span>
        <span class="k">if</span> <span class="n">issparse</span><span class="p">(</span><span class="n">primary_data</span><span class="p">):</span>
            <span class="n">primary_data</span> <span class="o">=</span> <span class="n">primary_data</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">primary_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_layers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">modality_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">modality_data</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine layers from a modality and return the combined data and indices.</span>

<span class="sd">        Args:</span>
<span class="sd">            modality_name: Name of the modality</span>
<span class="sd">            modality_data: Data for the modality</span>

<span class="sd">        Returns:</span>
<span class="sd">            Combined data and list of (layer_name, start_idx, end_idx) tuples</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">layer_indices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">selected_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_config</span><span class="o">.</span><span class="n">data_info</span><span class="p">[</span>
            <span class="n">modality_name</span>
        <span class="p">]</span><span class="o">.</span><span class="n">selected_layers</span>

        <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;combine layers&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="n">selected_layers</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;layer: </span><span class="si">{</span><span class="n">layer_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">layer_name</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_primary_data</span><span class="p">(</span><span class="n">modality_data</span><span class="p">)</span>
                <span class="n">layer_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">layer_indices</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">]</span>
                <span class="n">start_idx</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="n">modality_data</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="n">layer_data</span> <span class="o">=</span> <span class="n">modality_data</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">issparse</span><span class="p">(</span><span class="n">layer_data</span><span class="p">):</span>
                    <span class="n">layer_data</span> <span class="o">=</span> <span class="n">layer_data</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
                <span class="n">layer_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer_data</span><span class="p">)</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">layer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">layer_indices</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">]</span>
                <span class="n">start_idx</span> <span class="o">+=</span> <span class="n">layer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">combined_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">layer_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">layer_list</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">combined_data</span><span class="p">,</span> <span class="n">layer_indices</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_dataset_dict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">datapackage</span><span class="p">:</span> <span class="n">DataPackage</span><span class="p">,</span> <span class="n">split_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NumericDataset</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For each seperate entry in our datapackge we build a NumericDataset</span>
<span class="sd">        and store it in a dictionary with the modality as key.</span>

<span class="sd">        Args:</span>
<span class="sd">            datapackage:DataPackage containing the data to be processed</span>
<span class="sd">            split_indices: List of indices for splitting the data</span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary mapping modality names to NumericDataset objects</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataset_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NumericDataset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">layer_id_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">datapackage</span><span class="p">:</span>
            <span class="n">attr_name</span><span class="p">,</span> <span class="n">dict_key</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                <span class="s2">&quot;.&quot;</span>
            <span class="p">)</span>  <span class="c1"># see DataPackage __iter__ method for why this makes sense</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">datapackage</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># prevents error in Single Cell case</span>
                <span class="c1"># case where each numeric data has it&#39;s own annotation/metadata</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">datapackage</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dict_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># case where there is one &quot;paired&quot; metadata for all numeric data</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">datapackage</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;paired&quot;</span><span class="p">)</span>
                <span class="c1"># case where we have the unpaired case, but we have one metadata that included all samples across all numeric data</span>
                <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">datapackage</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;annotation key needs to be either &#39;paired&#39; match a key of the numeric data or only one key exists that holds all unpaired data, please adjust config, got: </span><span class="si">{</span><span class="n">datapackage</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="n">metadata_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">datapackage</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">datapackage</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metadata_key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">attr_name</span> <span class="o">==</span> <span class="s2">&quot;multi_bulk&quot;</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">datapackage</span><span class="p">[</span><span class="n">attr_name</span><span class="p">][</span><span class="n">dict_key</span><span class="p">]</span>
                <span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">NumericDataset</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">tensor</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">sample_ids</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                    <span class="n">feature_ids</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                    <span class="n">split_indices</span><span class="o">=</span><span class="n">split_indices</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">dataset_dict</span><span class="p">[</span><span class="n">dict_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
            <span class="k">elif</span> <span class="n">attr_name</span> <span class="o">==</span> <span class="s2">&quot;multi_sc&quot;</span><span class="p">:</span>
                <span class="n">mudata</span> <span class="o">=</span> <span class="n">datapackage</span><span class="p">[</span><span class="s2">&quot;multi_sc&quot;</span><span class="p">][</span><span class="s2">&quot;multi_sc&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mudata</span><span class="p">,</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;Expected a MuData object, but got an AnnData object.&quot;</span>
                    <span class="p">)</span>

                <span class="n">layer_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;building dataset_dict&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">mod_name</span><span class="p">,</span> <span class="n">mod_data</span> <span class="ow">in</span> <span class="n">mudata</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">layers</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_layers</span><span class="p">(</span>
                        <span class="n">modality_name</span><span class="o">=</span><span class="n">mod_name</span><span class="p">,</span> <span class="n">modality_data</span><span class="o">=</span><span class="n">mod_data</span>
                    <span class="p">)</span>
                    <span class="n">layer_id_dict</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">indices</span>
                    <span class="n">layer_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
                    <span class="n">mod_concat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">layer_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">NumericDataset</span><span class="p">(</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">mod_concat</span><span class="p">),</span>
                        <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                        <span class="n">sample_ids</span><span class="o">=</span><span class="n">mudata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">,</span>
                        <span class="n">feature_ids</span><span class="o">=</span><span class="n">mod_data</span><span class="o">.</span><span class="n">var_names</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer_list</span><span class="p">),</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="n">mod_data</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span>
                        <span class="n">split_indices</span><span class="o">=</span><span class="n">split_indices</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">dataset_dict</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layer_indices</span> <span class="o">=</span> <span class="n">layer_id_dict</span>
        <span class="k">return</span> <span class="n">dataset_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_reconstruction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">reconstruction</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Result</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataPackage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes the reconstructed tensor and from which modality it comes and uses the dataset_dict</span>
<span class="sd">        to obtain the format of the original datapackage, but instead of the .data attribute</span>
<span class="sd">        we populate this attribute with the reconstructed tensor (as pd.DataFrame or MuData object)</span>

<span class="sd">        Args:</span>
<span class="sd">            reconstruction: The reconstructed tensor</span>
<span class="sd">            result: Optional[Result] containing additional information</span>
<span class="sd">        Returns:</span>
<span class="sd">            DataPackage with reconstructed data in original format</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Result object is not provided. This is needed for the StackixPreprocessor.&quot;</span>
            <span class="p">)</span>
        <span class="n">reconstruction</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sub_reconstructions</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expected value to be of type dict for Stackix, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_case</span> <span class="o">==</span> <span class="n">DataCase</span><span class="o">.</span><span class="n">MULTI_BULK</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_multi_bulk</span><span class="p">(</span><span class="n">reconstruction</span><span class="o">=</span><span class="n">reconstruction</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_case</span> <span class="o">==</span> <span class="n">DataCase</span><span class="o">.</span><span class="n">MULTI_SINGLE_CELL</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_multi_sc</span><span class="p">(</span><span class="n">reconstruction</span><span class="o">=</span><span class="n">reconstruction</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported data_case </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_case</span><span class="si">}</span><span class="s2"> for StackixPreprocessor.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_multi_bulk</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">reconstructions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataPackage</span><span class="p">:</span>
        <span class="n">multi_bulk_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">annotation_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">DataPackage</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">reconstruction</span> <span class="ow">in</span> <span class="n">reconstructions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected value to be of type torch.Tensor, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dataset container is not initialized.&quot;</span><span class="p">)</span>
            <span class="n">stackix_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">stackix_ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No dataset found for split: test&quot;</span><span class="p">)</span>
            <span class="n">dataset_dict</span> <span class="o">=</span> <span class="n">stackix_ds</span><span class="o">.</span><span class="n">dataset_dict</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">reconstruction</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
                <span class="n">index</span><span class="o">=</span><span class="n">dataset_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="n">dataset_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">feature_ids</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">multi_bulk_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
            <span class="n">annotation_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span>

        <span class="n">dp</span><span class="p">[</span><span class="s2">&quot;multi_bulk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_bulk_dict</span>
        <span class="n">dp</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation_dict</span>
        <span class="k">return</span> <span class="n">dp</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_multi_sc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reconstruction</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DataPackage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Formats reconstructed tensors back into a MuData object for single-cell data.</span>

<span class="sd">        This uses the stored layer indices to accurately split the reconstructed tensor</span>
<span class="sd">        back into the original layers.</span>

<span class="sd">        Args:</span>
<span class="sd">        reconstruction: Dictionary of reconstructed tensors for each modality</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataPackage containing the reconstructed MuData object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">mudata</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">md</span>

        <span class="n">dp</span> <span class="o">=</span> <span class="n">DataPackage</span><span class="p">()</span>
        <span class="n">modalities</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dataset container is not initialized.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_layer_indices&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Layer indices not found. Make sure _build_dataset_dict was called.&quot;</span>
            <span class="p">)</span>

        <span class="n">stackix_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">stackix_ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No dataset found for split: test&quot;</span><span class="p">)</span>

        <span class="n">dataset_dict</span> <span class="o">=</span> <span class="n">stackix_ds</span><span class="o">.</span><span class="n">dataset_dict</span>

        <span class="c1"># Process each modality in the reconstruction</span>
        <span class="k">for</span> <span class="n">mod_name</span><span class="p">,</span> <span class="n">recon_tensor</span> <span class="ow">in</span> <span class="n">reconstruction</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recon_tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected value to be of type torch.Tensor, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">recon_tensor</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">mod_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Modality </span><span class="si">{</span><span class="n">mod_name</span><span class="si">}</span><span class="s2"> not found in dataset dictionary&quot;</span><span class="p">)</span>
            <span class="n">original_dataset</span> <span class="o">=</span> <span class="n">dataset_dict</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span>

            <span class="n">layer_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layer_indices</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span>

            <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="n">layer_indices</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span>
            <span class="n">x_data</span> <span class="o">=</span> <span class="n">recon_tensor</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:,</span> <span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>

            <span class="n">var_names</span> <span class="o">=</span> <span class="n">original_dataset</span><span class="o">.</span><span class="n">feature_ids</span>

            <span class="n">mod_data</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span>
                <span class="n">X</span><span class="o">=</span><span class="n">x_data</span><span class="p">,</span>
                <span class="n">obs</span><span class="o">=</span><span class="n">original_dataset</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">var</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">var_names</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">x_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
            <span class="p">)</span>

            <span class="c1"># Add additional layers based on stored indices</span>
            <span class="k">for</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">layer_indices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">layer_name</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># X is already set</span>

                <span class="n">layer_data</span> <span class="o">=</span> <span class="n">recon_tensor</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:,</span> <span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">mod_data</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_data</span>

            <span class="n">modalities</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_data</span>

        <span class="c1"># Create MuData object from all modalities</span>
        <span class="n">mdata</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">MuData</span><span class="p">(</span><span class="n">modalities</span><span class="p">)</span>

        <span class="c1"># Create and return DataPackage</span>
        <span class="n">dp</span><span class="p">[</span><span class="s2">&quot;multi_sc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;multi_sc&quot;</span><span class="p">:</span> <span class="n">mdata</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">dp</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.StackixPreprocessor.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">ontologies</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the StackixPreprocessor with the given configuration.
Args:
    config: Configuration parameters for preprocessing</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_stackix_preprocessor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span> <span class="n">ontologies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the StackixPreprocessor with the given configuration.</span>
<span class="sd">    Args:</span>
<span class="sd">        config: Configuration parameters for preprocessing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_datapackage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DatasetContainer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.StackixPreprocessor.format_reconstruction" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">format_reconstruction</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Takes the reconstructed tensor and from which modality it comes and uses the dataset_dict
to obtain the format of the original datapackage, but instead of the .data attribute
we populate this attribute with the reconstructed tensor (as pd.DataFrame or MuData object)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>reconstruction</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The reconstructed tensor</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>result</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="Result


  
      dataclass
   (autoencodix.utils._result.Result)" href="../utils/#autoencodix.utils.Result">Result</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[Result] containing additional information</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    DataPackage with reconstructed data in original format</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_stackix_preprocessor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">format_reconstruction</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">reconstruction</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Result</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataPackage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes the reconstructed tensor and from which modality it comes and uses the dataset_dict</span>
<span class="sd">    to obtain the format of the original datapackage, but instead of the .data attribute</span>
<span class="sd">    we populate this attribute with the reconstructed tensor (as pd.DataFrame or MuData object)</span>

<span class="sd">    Args:</span>
<span class="sd">        reconstruction: The reconstructed tensor</span>
<span class="sd">        result: Optional[Result] containing additional information</span>
<span class="sd">    Returns:</span>
<span class="sd">        DataPackage with reconstructed data in original format</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Result object is not provided. This is needed for the StackixPreprocessor.&quot;</span>
        <span class="p">)</span>
    <span class="n">reconstruction</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sub_reconstructions</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Expected value to be of type dict for Stackix, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_case</span> <span class="o">==</span> <span class="n">DataCase</span><span class="o">.</span><span class="n">MULTI_BULK</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_multi_bulk</span><span class="p">(</span><span class="n">reconstruction</span><span class="o">=</span><span class="n">reconstruction</span><span class="p">)</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_case</span> <span class="o">==</span> <span class="n">DataCase</span><span class="o">.</span><span class="n">MULTI_SINGLE_CELL</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_multi_sc</span><span class="p">(</span><span class="n">reconstruction</span><span class="o">=</span><span class="n">reconstruction</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported data_case </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_case</span><span class="si">}</span><span class="s2"> for StackixPreprocessor.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.StackixPreprocessor.preprocess" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">preprocess</span><span class="p">(</span><span class="n">raw_user_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Execute preprocessing steps for Stackix architecture.</p>
<p>Args
raw_user_data: Raw user data to preprocess, or None to use self._datapackage</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="DatasetContainer


  
      dataclass
   (autoencodix.data._datasetcontainer.DatasetContainer)" href="#autoencodix.data.DatasetContainer">DatasetContainer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Container with StackixDataset for each split</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If datapackage is None after preprocessing</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_stackix_preprocessor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">raw_user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataPackage</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DatasetContainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute preprocessing steps for Stackix architecture.</span>

<span class="sd">    Args</span>
<span class="sd">    raw_user_data: Raw user data to preprocess, or None to use self._datapackage</span>

<span class="sd">    Returns:</span>
<span class="sd">        Container with StackixDataset for each split</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If datapackage is None after preprocessing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_datapackage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_general_preprocess</span><span class="p">(</span><span class="n">raw_user_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span> <span class="o">=</span> <span class="n">DatasetContainer</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">split</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datapackage</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datapackage</span><span class="p">[</span><span class="n">split</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">continue</span>
        <span class="n">dataset_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_dataset_dict</span><span class="p">(</span>
            <span class="n">datapackage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_datapackage</span><span class="p">[</span><span class="n">split</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">],</span>
            <span class="n">split_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_datapackage</span><span class="p">[</span><span class="n">split</span><span class="p">][</span><span class="s2">&quot;indices&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">stackix_ds</span> <span class="o">=</span> <span class="n">MultiModalDataset</span><span class="p">(</span>
            <span class="n">datasets</span><span class="o">=</span><span class="n">dataset_dict</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">stackix_ds</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_container</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.TensorAwareDataset" class="doc doc-heading">
            <code>TensorAwareDataset</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseDataset (autoencodix.base._base_dataset.BaseDataset)" href="../base/#autoencodix.base.BaseDataset">BaseDataset</a></code></p>


        <p>Handles dtype mapping and tensor conversion logic.</p>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_numeric_dataset.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TensorAwareDataset</span><span class="p">(</span><span class="n">BaseDataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles dtype mapping and tensor conversion logic.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_to_tensor</span><span class="p">(</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert data to tensor with specified dtype.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: Input data to convert</span>
<span class="sd">            dtype: Desired data type</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tensor with the specified dtype</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_map_float_precision_to_dtype</span><span class="p">(</span><span class="n">float_precision</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map fabric precision types to torch tensor dtypes.</span>

<span class="sd">        Args:</span>
<span class="sd">            float_precision: Precision type (e.g., &#39;bf16-mixed&#39;, &#39;16-mixed&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Corresponding torch dtype</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">precision_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;transformer-engine&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>  <span class="c1"># Default for transformer-engine</span>
            <span class="s2">&quot;transformer-engine-float16&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
            <span class="s2">&quot;16-true&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
            <span class="s2">&quot;16-mixed&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
            <span class="s2">&quot;bf16-true&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span>
            <span class="s2">&quot;bf16-mixed&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span>
            <span class="s2">&quot;32-true&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;64-true&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;64&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s2">&quot;32&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s2">&quot;16&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
            <span class="s2">&quot;bf16&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># Default to torch.float32 if the precision is not recognized</span>
        <span class="k">return</span> <span class="n">precision_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">float_precision</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_to_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the dataset to a pandas DataFrame.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame representation of the dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_ids</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="p">):</span>
            <span class="c1"># Handle image modality</span>
            <span class="c1"># Get the list of tensors</span>
            <span class="n">tensor_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

            <span class="c1"># Flatten each tensor and collect as rows</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">t</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensor_list</span>
            <span class="p">]</span>

            <span class="c1"># Create DataFrame</span>
            <span class="n">df_flat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">rows</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Pixel_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]))],</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">df_flat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Data is not a torch.Tensor and cannot be converted to DataFrame.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_target_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the target dtype based on config, with MPS compatibility check.&quot;&quot;&quot;</span>
        <span class="n">target_dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_float_precision_to_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">float_precision</span><span class="p">)</span>

        <span class="c1"># MPS doesn&#39;t support float64, so fallback to float32</span>
        <span class="k">if</span> <span class="n">target_dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;mps&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: MPS doesn&#39;t support float64, using float32 instead&quot;</span><span class="p">)</span>
            <span class="n">target_dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span>

        <span class="k">return</span> <span class="n">target_dtype</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="autoencodix.data.XModalPreprocessor" class="doc doc-heading">
            <code>XModalPreprocessor</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="GeneralPreprocessor (autoencodix.data.general_preprocessor.GeneralPreprocessor)" href="#autoencodix.data.GeneralPreprocessor">GeneralPreprocessor</a></code></p>


        <p>Preprocessor for cross-modal data, handling multiple data types and their transformations.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.XModalPreprocessor.data_config">data_config</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration specific to data handling.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="autoencodix.data.XModalPreprocessor.dataset_dicts">dataset_dicts</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary holding datasets for different splits (train, test, valid).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/autoencodix/data/_xmodal_preprocessor.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">XModalPreprocessor</span><span class="p">(</span><span class="n">GeneralPreprocessor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Preprocessor for cross-modal data, handling multiple data types and their transformations.</span>


<span class="sd">    Attributes:</span>
<span class="sd">        data_config: Configuration specific to data handling.</span>
<span class="sd">        dataset_dicts: Dictionary holding datasets for different splits (train, test, valid).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span> <span class="n">ontologies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the XModalPreprocessor</span>
<span class="sd">        Args:</span>
<span class="sd">            config: Configuration object for the preprocessor.</span>
<span class="sd">            ontologies: Optional ontologies for data processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">ontologies</span><span class="o">=</span><span class="n">ontologies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">data_config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raw_user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataPackage</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">predict_new_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DatasetContainer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Preprocess the data according to the configuration.</span>
<span class="sd">        Args:</span>
<span class="sd">            raw_user_data: Optional raw data provided by the user.</span>
<span class="sd">            predict_new_data: Flag indicating if new data is being predicted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_general_preprocess</span><span class="p">(</span>
            <span class="n">raw_user_data</span><span class="o">=</span><span class="n">raw_user_data</span><span class="p">,</span> <span class="n">predict_new_data</span><span class="o">=</span><span class="n">predict_new_data</span>
        <span class="p">)</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">]:</span>
            <span class="n">cur_split</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dicts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cur_split</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;split is None: </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">cur_data</span> <span class="o">=</span> <span class="n">cur_split</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur_data</span><span class="p">,</span> <span class="n">DataPackage</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;expected type of cur_data to be DataPackage, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cur_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">cur_indices</span> <span class="o">=</span> <span class="n">cur_split</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;indices&quot;</span><span class="p">)</span>
            <span class="n">datasets</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">MultiModalDataset</span><span class="p">(</span>
                <span class="n">datasets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_dp</span><span class="p">(</span><span class="n">dp</span><span class="o">=</span><span class="n">cur_data</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">cur_indices</span><span class="p">),</span>
                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;key: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">, type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">DatasetContainer</span><span class="p">(</span>
            <span class="n">train</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span> <span class="n">test</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">],</span> <span class="n">valid</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_reconstruction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reconstruction</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_dp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dp</span><span class="p">:</span> <span class="n">DataPackage</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Processes a DataPackage into a dictionary of BaseDataset objects.</span>

<span class="sd">        Args:</span>
<span class="sd">            dp: The DataPackage to process.</span>
<span class="sd">            indices: The indices for splitting the data.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A dictionary mapping modality names to BaseDataset objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dataset_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseDataset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dp</span><span class="p">:</span>
            <span class="n">dp_key</span><span class="p">,</span> <span class="n">sub_key</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">dp</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># prevents error in SingleCell case</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sub_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;paired&quot;</span><span class="p">)</span>
                <span class="c1"># case where we have the unpaired case, but we have one metadata that included all samples across all numeric data</span>
                <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;annotation key needs to be either &#39;paired&#39; match a key of the numeric data or only one key exists that holds all unpaired data, please adjust config, got: </span><span class="si">{</span><span class="n">dp</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="n">metadata_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metadata_key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dp_key</span> <span class="o">==</span> <span class="s2">&quot;multi_bulk&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Expected data for multi_bulk: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> to be pd.DataFrame, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;metadata cannot be None&quot;</span><span class="p">)</span>
                <span class="n">metadata_num</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">index</span>
                <span class="p">]</span>  <span class="c1"># needed when we have only one annotation df containing metadata for all modalities</span>
                <span class="n">dataset_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumericDataset</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">sample_ids</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                    <span class="n">feature_ids</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                    <span class="n">split_indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="n">metadata_num</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">dp_key</span> <span class="o">==</span> <span class="s2">&quot;img&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ImgData</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
                <span class="n">dataset_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImageDataset</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">split_indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">dp_key</span> <span class="o">==</span> <span class="s2">&quot;multi_sc&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">md</span><span class="o">.</span><span class="n">MuData</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">mod_key</span><span class="p">,</span> <span class="n">mod_data</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">mod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">selected_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data_config</span><span class="o">.</span><span class="n">data_info</span><span class="p">[</span>
                        <span class="n">mod_key</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">selected_layers</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_layers</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                            <span class="s2">&quot;Xmodalix works only with X layer of single cell data as of now&quot;</span>
                        <span class="p">)</span>
                    <span class="n">x_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_primary_data</span><span class="p">(</span><span class="n">modality_data</span><span class="o">=</span><span class="n">mod_data</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">dataset_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">NumericDataset</span><span class="p">(</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">x_data</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                        <span class="n">sample_ids</span><span class="o">=</span><span class="n">mod_data</span><span class="o">.</span><span class="n">obs_names</span><span class="p">,</span>
                        <span class="n">feature_ids</span><span class="o">=</span><span class="n">mod_data</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span>
                        <span class="n">split_indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="n">mod_data</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">elif</span> <span class="n">dp_key</span> <span class="o">==</span> <span class="s2">&quot;annotation&quot;</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Got datapackage attribute: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">, probably you have added an attribute to the Datapackage class without adjusting this method. Only supports: [&#39;multi_bulk&#39;, &#39;multi_sc&#39;, &#39;img&#39; and &#39;annotation&#39;]&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">dataset_dict</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.XModalPreprocessor.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">ontologies</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initializes the XModalPreprocessor
Args:
    config: Configuration object for the preprocessor.
    ontologies: Optional ontologies for data processing.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_xmodal_preprocessor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">DefaultConfig</span><span class="p">,</span> <span class="n">ontologies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the XModalPreprocessor</span>
<span class="sd">    Args:</span>
<span class="sd">        config: Configuration object for the preprocessor.</span>
<span class="sd">        ontologies: Optional ontologies for data processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">ontologies</span><span class="o">=</span><span class="n">ontologies</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">data_config</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="autoencodix.data.XModalPreprocessor.preprocess" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">preprocess</span><span class="p">(</span><span class="n">raw_user_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">predict_new_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Preprocess the data according to the configuration.
Args:
    raw_user_data: Optional raw data provided by the user.
    predict_new_data: Flag indicating if new data is being predicted.</p>


            <details class="quote">
              <summary>Source code in <code>src/autoencodix/data/_xmodal_preprocessor.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">raw_user_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataPackage</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">predict_new_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DatasetContainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Preprocess the data according to the configuration.</span>
<span class="sd">    Args:</span>
<span class="sd">        raw_user_data: Optional raw data provided by the user.</span>
<span class="sd">        predict_new_data: Flag indicating if new data is being predicted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dicts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_general_preprocess</span><span class="p">(</span>
        <span class="n">raw_user_data</span><span class="o">=</span><span class="n">raw_user_data</span><span class="p">,</span> <span class="n">predict_new_data</span><span class="o">=</span><span class="n">predict_new_data</span>
    <span class="p">)</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">]:</span>
        <span class="n">cur_split</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dicts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cur_split</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;split is None: </span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">cur_data</span> <span class="o">=</span> <span class="n">cur_split</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur_data</span><span class="p">,</span> <span class="n">DataPackage</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;expected type of cur_data to be DataPackage, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cur_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">cur_indices</span> <span class="o">=</span> <span class="n">cur_split</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;indices&quot;</span><span class="p">)</span>
        <span class="n">datasets</span><span class="p">[</span><span class="n">split</span><span class="p">]</span> <span class="o">=</span> <span class="n">MultiModalDataset</span><span class="p">(</span>
            <span class="n">datasets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_dp</span><span class="p">(</span><span class="n">dp</span><span class="o">=</span><span class="n">cur_data</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">cur_indices</span><span class="p">),</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_dicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;key: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">, type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">DatasetContainer</span><span class="p">(</span>
        <span class="n">train</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span> <span class="n">test</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">],</span> <span class="n">valid</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>